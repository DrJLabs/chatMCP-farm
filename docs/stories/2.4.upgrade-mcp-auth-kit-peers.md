# Story 2.4: Upgrade Auth Kit Peer Dependencies and Documentation

## Status
Done

## Story
**As a** platform engineer stewarding our shared MCP auth kit,
**I want** to align its peer dependencies, migration notes, and workspace regression helpers with the Express 5 baseline,
**so that** every service can adopt the upgraded stack without Express 4 residue or manual post-bump verification.

## Acceptance Criteria
1. `packages/mcp-auth-kit/package.json` reflects Express 5 adoption: peer dependency range covers `express@^5.1.x`, `jose` is updated to `^6.1.0`, legacy `@types/express*` dev dependencies are removed, and the package builds successfully via `npm run build --workspace packages/mcp-auth-kit`. [Source: docs/stories/epic-dependency-alignment.md#stories] [Source: docs/architecture.md#3-1-shared-packages-packages]
2. The workspace exposes a dedicated post-bump helper script (e.g., `npm run postbump:test`) that invokes `npm run test --workspaces --if-present`, and the README documents running it after dependency upgrades; executing the helper confirms lint/test suites pass on Node 22. [Source: docs/stories/epic-dependency-alignment.md#stories] [Source: docs/architecture.md#9-testing-strategy]
3. Documentation reflects the Express 5 baseline: `docs/architecture/tech-stack.md` and related shards describe Express 5 as the standard, note the removal of external Express typings, and provide rollback guidance consistent with the operational playbook. [Source: docs/stories/epic-dependency-alignment.md#definition-of-done] [Source: docs/architecture.md#10-operational-playbook]
4. `packages/mcp-auth-kit/README.md` includes migration notes covering the peer range change, guidance to run the new post-bump helper, and references to rollback/verification steps; changelog entry captured in story file. [Source: docs/stories/epic-dependency-alignment.md#epic-description] [Source: docs/architecture/source-tree.md#guidelines]

## Tasks / Subtasks
- [x] Audit current `packages/mcp-auth-kit` dependencies, record the existing `package-lock.json` hash, and confirm Express 4 peers/types are the remaining blockers flagged by Story 2.1. (AC: 1) [Source: docs/stories/2.1.upgrade-mcp-test-server-deps.md#dev-notes]
- [x] Update `packages/mcp-auth-kit/package.json` to relax peers to Express 5, bump `jose` to ^6.1.0, and remove redundant Express typings; rebuild and ensure dist output regenerates. (AC: 1) [Source: docs/stories/epic-dependency-alignment.md#stories]
  - [x] Run `npm ls express --workspaces` and `npm ls @types/express --workspaces` to verify no Express 4 residue remains outside allowed transitive dependencies. (AC: 1) [Source: docs/stories/epic-dependency-alignment.md#risk-mitigation]
- [x] Add workspace post-bump script (e.g., `postbump:test`) that wraps `npm run test --workspaces --if-present`, update README usage instructions, ensure CI documentation references it, and wire the root `package.json` script plus README callouts. (AC: 2) [Source: docs/stories/epic-dependency-alignment.md#stories]
  - [x] Execute the helper on Node 22 to validate cross-workspace lint/test parity; document results in Dev Notes. (AC: 2) [Source: docs/architecture.md#9-testing-strategy]
  - [x] Confirm the helper passes under Node 20.19+ (for `require(esm)` compatibility) and note any deviations for earlier LTS releases. (AC: 2)
- [x] Update architecture shards (`tech-stack.md`, `coding-standards.md` if needed) to cite Express 5 baseline and describe rollback expectations; align with operational playbook guidance. (AC: 3) [Source: docs/stories/epic-dependency-alignment.md#definition-of-done]
  - [x] Capture rollback steps and doc update summary in Story change log plus README migration section. (AC: 3,4) [Source: docs/architecture.md#10-operational-playbook]
- [x] Extend `packages/mcp-auth-kit/README.md` with migration notes, usage guidance for the helper script, and Express 5 peer expectations. (AC: 4) [Source: docs/stories/epic-dependency-alignment.md#epic-description]

## Dev Notes
- **Previous Story Insights:** Story 2.1 confirmed Express 5 services still depend on `mcp-auth-kit` retaining Express 4 peers/types; this story must eliminate that final mismatch. [Source: docs/stories/2.1.upgrade-mcp-test-server-deps.md#dev-notes]
- **Data Models:** No persistent schemas; focus on auth kit configuration objects surfaced through `loadAuthKitOptionsFromEnv`. [Source: docs/architecture.md#3-1-shared-packages-packages]
- **API Specifications:** Auth kit must continue exporting manifest, PRM, and auth guard middleware with identical Express signatures while targeting Express 5 types. [Source: docs/architecture.md#3-1-shared-packages-packages]
- **Component Specifications:** Package lives under `packages/mcp-auth-kit` with build artifacts in `dist/`; ensure TypeScript config remains aligned with Express 5 runtime. [Source: docs/architecture/source-tree.md#source-tree-reference]
- **File Locations:** Update `packages/mcp-auth-kit/package.json`, `README.md`, and root `package.json`; consider doc shards under `docs/architecture/`. [Source: docs/architecture/source-tree.md#guidelines]
- **Testing Requirements:** Follow workspace testing strategyâ€”run lint/test/build across workspaces and confirm auth kit build passes under Node 22. [Source: docs/architecture.md#9-testing-strategy]
- **Technical Constraints:** Maintain Node `^22 || ^24` compatibility, enforce TypeScript strict mode, and keep Streamable HTTP defaults through auth kit middleware. [Source: docs/architecture/tech-stack.md#tech-stack] [Source: docs/architecture/coding-standards.md#coding-standards]
- **Dependency Updates:** `jose` v6 introduces PQC-friendly algorithm identifiers and maintains Node 18+ support (CommonJS `require` available from Node 20.19+ via `require(esm)`); ensure peers/docs capture these constraints. [Research: jose v6.1.0 release] [Research: jose v5 announcement]

## Testing
- Run `npm run build --workspace packages/mcp-auth-kit` and `npm run test --workspaces --if-present` (via the new helper) to validate peer updates across packages. [Source: docs/architecture.md#9-testing-strategy]
- Execute `npm ls express --workspaces` and `npm ls @types/express --workspaces` to confirm Express 4 residue is removed outside controlled exceptions. [Source: docs/stories/epic-dependency-alignment.md#risk-mitigation]

## ðŸ”¬ Research & Validation Log
- 2025-09-24: Reviewed Express v5 release guidance to reiterate built-in async error handling expectations before updating peer dependencies. [Research: Express 5 release notes]
- 2025-09-24: Confirmed `jose` v6.1.0 feature set (AKP JWK support, ML-DSA identifiers) and verified Node runtime support policies for v6.x while planning peer bump. [Research: jose v6.1.0 release]
- 2025-09-24: Validated npm workspaces guidance for root-level scripts invoking all workspace tests, informing the `postbump:test` helper design. [Research: npm workspaces run documentation]

## Change Log
| Date       | Version | Description                                    | Author |
|------------|---------|------------------------------------------------|--------|
| 2025-09-24 | 1.0     | Merged via PR #17; story closed after QA/PO validation and follow-up completion. | Sarah |
| 2025-09-24 | 0.2     | Implemented Express 5 peer upgrade, added postbump helper, and refreshed docs. | James |
| 2025-09-24 | 0.1     | Initial draft for Story 2.4 peer upgrade plan. | Codex  |

## Dev Agent Record
### Agent Model Used
Codex GPT-5 (dev)

### Debug Log References
- `npm install`
- `npm run build --workspace packages/mcp-auth-kit`
- `npm run postbump:test`
- `POSTBUMP_NODE_VERSION=20.18.0 node scripts/postbump-test.mjs`
- `npm ls express --workspaces`
- `npm ls @types/express --workspaces`

### Completion Notes List
- Updated `packages/mcp-auth-kit` to depend on `jose@^6.1.0`, require Express 5.1 peers, and regenerated the workspace lockfile without Express 4 artifacts (AC1).
- Added the `postbump:test` helper with runtime guard plus README guidance, then executed it on Node 22 and simulated a Node 20.18 failure to document the guard behaviour (AC2).
- Refreshed architecture shards and follow-ups to reflect the Express 5 baseline and close the tracked dependency warning (AC3).
- Documented migration notes in `packages/mcp-auth-kit/README.md` and highlighted the helper in the workspace README for operators (AC4).

### File List
- README.md
- docs/architecture/coding-standards.md
- docs/architecture/tech-stack.md
- docs/stories/follow-ups.md
- package-lock.json
- package.json
- packages/mcp-auth-kit/README.md
- packages/mcp-auth-kit/package.json
- scripts/postbump-test.mjs
- docs/stories/2.4.upgrade-mcp-auth-kit-peers.md
## QA Results

- 2025-09-24: QA review PASS with gate recorded at `docs/qa/gates/2.4-upgrade-auth-kit.yml`; all P0 scenarios executed via `npm run postbump:test` and targeted unit tests (`docs/qa/assessments/2.4-risk-20250924.md`, `docs/qa/assessments/2.4-test-design-20250924.md`).
