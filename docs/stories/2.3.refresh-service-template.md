# Story 2.3: Refresh Service Template for Express 5 Baseline

## Status
Done

## Story
**As a** developer bootstrapping new MCP services,
**I want** the `templates/service` scaffold to match the Express 5 + Vitest 3 baseline,
**so that** future services launch without retrofitting dependency upgrades.

## Acceptance Criteria
1. `templates/service/package.json`, `tsconfig*.json`, `vitest.config.ts`, smoke script, and Dockerfile mirror the Express 5 / MCP SDK 1.18.1 stack delivered in Stories 2.1 and 2.2: runtime dependencies pin `express@^5.1.0`, `@modelcontextprotocol/sdk@^1.18.1`, `zod@^3.24.x`, `morgan@^1.10.0`, and `mcp-auth-kit` (workspace file reference), while dev dependencies adopt `vitest@^3.2.x`, `@vitest/coverage-v8@^3.2.x`, `supertest@^7.1.x`, `@types/supertest@^2.0.16`, `tsx@^4.19.x`, `typescript@^5.6.3`, `@types/node@^22.9.x`, `@types/cors@^2.8.17`, and `@types/morgan@^1.9.9`. Template scripts expose `npm run lint` (TypeScript no-emit) alongside `test`, `build`, and `smoke`, and generated services must report a single Express 5 tree via `npm ls express --workspace <scaffold>` (no Express 4 residue). [Source: docs/stories/epic-dependency-alignment.md#stories] [Source: docs/stories/2.1.upgrade-mcp-test-server-deps.md#dev-notes] [Source: docs/stories/2.2.upgrade-github-mcp-deps.md#dev-notes] [Source: docs/architecture/tech-stack.md#tech-stack]
2. Template documentation and configs reflect the new baseline: README, `.env.example`, and `compose.yml` name Express 5, reference the `postbump:test` helper for regression checks, and preserve bootstrap guidance from the architecture shards. Any rollback note points to the pre-upgrade commit or branch. [Source: docs/architecture/source-tree.md#source-tree-reference] [Source: docs/bootstrap-checklist.md#bootstrap-steps] [Source: docs/stories/2.4.upgrade-mcp-auth-kit-peers.md#dev-notes]
3. Running `scripts/bootstrap.sh <service>` produces a workspace entry that succeeds with `npm run lint|test|build --workspace <service>`, `npm run smoke --workspace <service>`, and the root `npm run postbump:test` on Node 22, capturing evidence for the Dev Agent Record. [Source: docs/architecture.md#33-templates--scripts] [Source: docs/architecture.md#9-testing-strategy]
4. Story notes document sequencing with `mcp-auth-kit`: confirm the template consumes the updated Express 5 peer range, log follow-ups in `docs/stories/follow-ups.md` only if new peer warnings appear, and highlight any remaining blockers for downstream services. [Source: docs/stories/epic-dependency-alignment.md#stories] [Source: docs/stories/follow-ups.md#open-items] [Source: docs/stories/2.4.upgrade-mcp-auth-kit-peers.md#dev-notes]

## Tasks / Subtasks
- [x] Review Stories 2.1, 2.2, and 2.4 completion notes to capture dependency versions, Vitest adjustments, and postbump helper expectations (AC: 1, 2, 4). [Source: docs/stories/2.1.upgrade-mcp-test-server-deps.md#dev-notes] [Source: docs/stories/2.2.upgrade-github-mcp-deps.md#dev-notes] [Source: docs/stories/2.4.upgrade-mcp-auth-kit-peers.md#dev-notes]
- [x] Update `templates/service/package.json` dependency ranges, Node engine, and scripts to align with Express 5 + Vitest 3; remove legacy Express 4 typings, surface a `lint` script (`tsc --noEmit`), and ensure `tsconfig*.json` and `vitest.config.ts` mirror changes applied in Stories 2.1/2.2 (AC: 1). [Source: docs/stories/epic-dependency-alignment.md#stories] [Source: docs/architecture/tech-stack.md#tech-stack]
  - [x] Regenerate the template smoke script and TypeScript configs to use the same assertions and strict settings as `services/mcp-test-server` (`Vitest` coverage, async error handling) (AC: 1). [Source: docs/architecture.md#32-services-services] [Source: docs/architecture.md#9-testing-strategy]
- [x] Refresh template README, `.env.example`, and `compose.yml` to call out Express 5 defaults, the `postbump:test` helper, rollback instructions, and security reminders (AC: 2, 4). [Source: docs/architecture/source-tree.md#source-tree-reference] [Source: docs/bootstrap-checklist.md#smoke-workflow]
  - [x] Verify `scripts/bootstrap.sh` messaging (next steps) matches the updated workflow, including running workspace tests and the postbump helper (AC: 2). [Source: docs/architecture.md#33-templates--scripts]
- [x] Generate a demo scaffold (e.g., `scripts/bootstrap.sh express5-demo`), run `npm install --workspace services/express5-demo`, then execute lint/test/build/smoke plus `npm run postbump:test` to confirm compatibility; capture `npm ls express --workspace services/express5-demo` output (AC: 1, 3). [Source: docs/architecture.md#9-testing-strategy]
  - [x] Document test evidence (including `npm run lint`, coverage output, and `npm ls express`) and any residual peer warnings in the story Dev Agent Record or `docs/stories/follow-ups.md` (AC: 1, 3, 4). [Source: docs/stories/follow-ups.md#open-items]
- [x] If blockers remain (e.g., downstream packages on Express 4), note sequencing requirements in Dev Notes and open a follow-up item (AC: 4). [Source: docs/stories/epic-dependency-alignment.md#risk-mitigation]

## Dev Notes
- **Previous Story Insights:** Stories 2.1 and 2.2 captured the required dependency matrix, Express 5 async semantics, and Vitest 3 coverage changes that the template must inherit; Story 2.4 introduced the `postbump:test` helper and removed auth-kit peer warningsâ€”mirror those expectations here. [Source: docs/stories/2.1.upgrade-mcp-test-server-deps.md#dev-notes] [Source: docs/stories/2.2.upgrade-github-mcp-deps.md#dev-notes] [Source: docs/stories/2.4.upgrade-mcp-auth-kit-peers.md#dev-notes]
- **Data Models:** Template services remain stateless; focus on diagnostics payloads defined in `src/mcp.ts` once scaffolds are generated (no schema changes required). [Source: docs/architecture.md#32-services-services]
- **API Specifications:** Preserve Streamable HTTP endpoints (`/.well-known/mcp/manifest.json`, `/mcp`, `/debug/*`) and OAuth guard wiring from `mcp-auth-kit`, ensuring Express 5 routing stays compatible. [Source: docs/architecture.md#21-technical-summary]
- **Component Specifications:** Template provides Express app with middleware ordering (auth guard, logging, diagnostics) and SSE optionality; updates must keep that order intact while adopting Express 5 types. [Source: docs/architecture.md#32-services-services]
- **File Locations:** All template assets live under `templates/service/` (`package.json`, `tsconfig*.json`, `src/`, `test/`, README, compose snippet); `scripts/bootstrap.sh` copies these into `services/<name>`. [Source: docs/architecture/source-tree.md#source-tree-reference] [Source: docs/architecture.md#33-templates--scripts]
- **Testing Requirements:** Follow workspace testing strategyâ€”lint, unit/integration (Vitest + Supertest), smoke Streamable HTTP flows, and run the `postbump:test` helper after dependency updates. [Source: docs/architecture.md#9-testing-strategy] [Source: docs/stories/2.4.upgrade-mcp-auth-kit-peers.md#acceptance-criteria]
- **Technical Constraints:** Maintain Node `^22 || ^24` engines, TypeScript strict mode from `tsconfig.base.json`, Streamable HTTP as default transport, and rely on Express 5 built-in async error propagation (no `express-async-errors`). [Source: docs/architecture/tech-stack.md#tech-stack] [Source: docs/architecture/coding-standards.md#coding-standards]
- **Documentation Alignment:** Update template README and bootstrap messaging to reinforce the Express 5 baseline and smoke workflow, matching the architecture bootstrap checklist. [Source: docs/bootstrap-checklist.md#bootstrap-steps] [Source: docs/bootstrap-checklist.md#smoke-workflow]

## Testing
- `scripts/bootstrap.sh <service>` â†’ `npm install --workspace services/<service>` â†’ `npm run lint|test|build --workspace services/<service>` â†’ `npm run smoke --workspace services/<service>` â†’ `npm run postbump:test`. [Source: docs/architecture.md#9-testing-strategy]
- `npm ls express --workspace services/<service>` and `npm ls @types/express --workspace services/<service>` to verify Express 5 peer alignment. [Source: docs/stories/epic-dependency-alignment.md#risk-mitigation]

## ðŸ”¬ Research & Validation Log
- **2025-09-24 â€“ Validation Summary:** Confirmed Express 5.1â€²s native async error propagation removes the need for `express-async-errors`, so the template must rely on built-in handlers and clean up legacy typings. [Source: https://expressjs.com/2024/10/15/v5-release]
- **2025-09-24 â€“ Testing Guidance Update:** Vitest 3.2 recommends V8 coverage via `@vitest/coverage-v8` with AST-aware remapping; ensured acceptance criteria and tasks require installing the package and wiring coverage settings. [Source: https://vitest.dev/blog/vitest-3-2.html]
- **2025-09-24 â€“ Runtime Alignment:** Verified Node.js 22.x is Active LTS through April 30, 2027, keeping template engines `^22 || ^24` aligned with support windows. [Source: https://nodejs.org/en/about/releases/]
- **Outstanding Risks:** Keep monitoring Vitest coverage remapping performance regressions in large monorepos; if the AST-aware mode surfaces coverage drift, document mitigations or consider fallback reporters in implementation notes.

## Change Log

| Date       | Version | Description                                                         | Author |
|------------|---------|---------------------------------------------------------------------|--------|
| 2025-09-24 | 0.2     | Expanded acceptance criteria, tasks, and notes for Express 5 template refresh. | Codex |
| 2025-09-24 | 0.1     | Initial draft capturing Express 5 template refresh.                 | Codex |


## Dev Agent Record
### Agent Model Used
- Codex (GPT-5) â€” 2025-09-24

### Debug Log References
- `npm run lint --workspace services/express5-demo`
- `npm run test --workspace services/express5-demo -- --coverage`
- `npm run build --workspace services/express5-demo`
- `npm run smoke --workspace services/express5-demo`
- `npm run postbump:test`
- `npm ls express --workspace services/express5-demo`
- `npm ls @types/express --workspace services/express5-demo`

### Completion Notes List
- Updated the service template to the Express 5/Vitest 3 baseline, refreshed bootstrap messaging, and aligned `scripts/bootstrap.sh` guidance with the postbump helper.
- Scaffolded `services/express5-demo`, executed lint/test/build/smoke plus `npm run postbump:test`, and captured Express dependency trees â€” no Express 4 residue or peer warnings surfaced.
- Used `.env` overrides solely for local smoke validation; no new follow-up items required because `mcp-auth-kit` peers already align with Express 5.

### File List
- docs/stories/2.3.refresh-service-template.md
- docs/qa/assessments/2.3-risk-20250924.md (new)
- docs/qa/assessments/2.3-test-design-20250924.md (new)
- package-lock.json
- scripts/bootstrap.sh
- templates/service/.env.example
- templates/service/Dockerfile
- templates/service/README.md
- templates/service/compose.yml
- templates/service/package.json
- templates/service/src/mcp.ts
- templates/service/src/smoke.ts
- templates/service/test/accept-header.spec.ts
- templates/service/test/diagnostics.spec.ts
- templates/service/tsconfig.build.json
- templates/service/tsconfig.json
- templates/service/vitest.config.ts
- services/express5-demo/** (new scaffold for validation)

## QA Results
- 2025-09-24 â€“ PASS (Quinn): Gate complete; see `docs/qa/gates/2.3-refresh-service-template.yml`, trace matrix (`docs/qa/assessments/2.3-trace-20250924.md`), NFR assessment (`docs/qa/assessments/2.3-nfr-20250924.md`), risk profile, and test design updates. All acceptance criteria traced with full coverage and no outstanding follow-ups.
