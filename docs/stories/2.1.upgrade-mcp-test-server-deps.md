# Story 2.1: Upgrade MCP Test Server Dependency Stack

## Status
Done

## Story
**As a** platform engineer maintaining the MCP reference server,
**I want** to align `services/mcp-test-server` with the Express 5 and updated SDK/tooling stack,
**so that** we eliminate dual Express trees, keep TypeScript support current, and ensure smoke tests remain reliable on Node 22.

## Acceptance Criteria
1. `services/mcp-test-server/package.json` and `package-lock.json` pin `@modelcontextprotocol/sdk@^1.18.1`, `express@^5.1.0`, `zod@^3.24.x`, `supertest@^7.1.x`, `vitest@^3.2.x`, `@vitest/coverage-v8@^3.2.x`, `typescript@^5.6.3`, and `@types/node@^22.9.x`; redundant Express 4 artifacts (including `@types/express*`) are removed. [Source: docs/stories/epic-dependency-alignment.md#stories]
2. Express 5 changes compile without type errors: middleware signatures, async handlers, and router setup in `src/app.ts`, `src/server.ts`, and `src/mcp.ts` follow the updated Express 5 patterns (built-in async support, `RequestHandler` generics, error handler `(err, req, res, next)` signature) while preserving `mcp-auth-kit` wiring. [Source: docs/architecture.md#32-services-services] [Source: docs/architecture/coding-standards.md#coding-standards]
3. Vitest 3 migration succeeds: `vitest.config.ts`, test utilities, and scripts execute under Node 22 with `npm run lint|test|build --workspace mcp-test-server`, `npm run smoke`, and the new workspace aggregate test script (if introduced) all passing. [Source: docs/architecture.md#9-testing-strategy] [Source: docs/architecture/coding-standards.md#coding-standards]
4. Service documentation stays accurate: README and `.env.example` note the Express 5 baseline, document any CLI/script changes (e.g., workspace aggregate test runner), and a rollback note references restoring the pre-upgrade branch/lockfile snapshot. [Source: docs/architecture/source-tree.md#source-tree-reference] [Source: docs/stories/epic-dependency-alignment.md#definition-of-done]

## Tasks / Subtasks
- [x] Audit current dependency versions, capture baseline lockfile hash, and document the rollback branch/tag reference in README notes (AC: 1, 4) [Source: docs/stories/epic-dependency-alignment.md#epic-description]
- [x] Update runtime dependencies in `services/mcp-test-server/package.json` and regenerate `package-lock.json`, ensuring Express 4 artifacts are removed and npm dedupe succeeds (AC: 1) [Source: docs/stories/epic-dependency-alignment.md#stories]
  - [x] Confirm no lingering `@types/express*` or Express 4 transitive packages remain via `npm ls express` and `npm ls @types/express` (AC: 1) [Source: docs/stories/epic-dependency-alignment.md#risk-mitigation]
- [x] Refactor middleware and error handlers for Express 5 (async handlers, `next` usage) in `src/app.ts`, `src/server.ts`, and `src/mcp.ts`, preserving auth kit integration (AC: 2) [Source: docs/architecture.md#32-services-services] [Source: docs/architecture/coding-standards.md#coding-standards]
  - [x] Update TypeScript typings/imports to rely on built-in Express 5 types, adjust custom `ErrorRequestHandler` definitions, and verify strict mode passes (AC: 2) [Source: docs/architecture/coding-standards.md#coding-standards]
- [x] Upgrade Vitest configuration and tests to v3 (coverage plugin, config flags, test utils) and rerun lint/build/test/smoke scripts plus any workspace aggregate test command (AC: 3) [Source: docs/architecture.md#9-testing-strategy]
  - [x] Document new Vitest CLI usage in README, note coverage integration changes, and ensure `npm run smoke` remains valid (AC: 3, 4) [Source: docs/architecture/source-tree.md#source-tree-reference]
- [x] Refresh README, `.env.example`, and rollback instructions to highlight Express 5 baseline, mention architecture tech stack pending update, and point to the saved pre-upgrade snapshot (AC: 4) [Source: docs/stories/epic-dependency-alignment.md#definition-of-done]
  - [x] Log any post-upgrade follow-ups (if needed) in `docs/stories/follow-ups.md` (AC: 4) [Source: docs/stories/follow-ups.md#open-items]

## Dev Notes
- **Previous Story Insights:** Story 1.2 introduced env-driven manifest metadata and diagnostics coverage; Story 1.3 ensured compose and smoke workflows document Accept headers and profile activation, both of which should still operate after dependency bumps. Preserve diagnostics payloads and smoke scripts during the upgrade. [Source: docs/stories/1.2.oauth-manifest-tool-behavior.md#dev-notes] [Source: docs/stories/1.3.compose-integration-runbook.md#dev-notes]
- **Data Models:** No schema changes expected; the service remains stateless, returning diagnostics metadata and tool outputs defined in `mcp.ts`. [Source: docs/architecture.md#32-services-services]
- **API Specifications:** Maintain Streamable HTTP transport contracts and diagnostics endpoints; ensure Express 5 migration keeps existing routes (`/.well-known/mcp/manifest.json`, `/mcp`, `/diagnostics`) compatible. [Source: docs/architecture.md#21-technical-summary]
- **Component Specifications:** Service uses Express with `mcp-auth-kit`; confirm middleware order matches documented pattern (auth, logging, diagnostics). [Source: docs/architecture.md#32-services-services]
- **File Locations:** Key files reside in `services/mcp-test-server/src/` alongside Vitest config and README per source tree guidance. [Source: docs/architecture/source-tree.md#source-tree-reference]
- **Testing Requirements:** Follow architecture testing strategyâ€”unit/integration coverage with Vitest + Supertest, smoke Streamable HTTP flows, rerun lint/build/test scripts and any workspace aggregate test script post-upgrade. [Source: docs/architecture.md#9-testing-strategy]
- **Technical Constraints:** Maintain Node `^22 || ^24` engines, TypeScript strict mode, default Streamable HTTP transport, and ensure Express 5's built-in async support eliminates reliance on `express-async-errors`; note architecture tech stack still lists Express 4 pending Story 2.4 updateâ€”call out mismatch in README notes. [Source: docs/architecture/tech-stack.md#tech-stack] [Source: docs/architecture/coding-standards.md#coding-standards]

## Testing
- Run `npm run lint --workspace mcp-test-server`, `npm run test --workspace mcp-test-server`, `npm run build --workspace mcp-test-server`, and `npm run smoke` to confirm Express 5 + Vitest 3 compatibility. [Source: docs/architecture.md#9-testing-strategy]
- Execute `npm ls express` to verify only Express 5 is installed. [Source: docs/stories/epic-dependency-alignment.md#risk-mitigation]

## ðŸ”¬ Research & Validation Log
- 2025-09-24: Reviewed Express 5.1 migration notes to confirm built-in async handlers and updated error signatures; added explicit tasks to adjust `ErrorRequestHandler` usage and remove `express-async-errors` dependencies. Source: Express.js Blog â€“ "Express 5.1 Released" (accessed 2025-09-24).
- 2025-09-24: Validated Vitest 3 upgrade guidance covering coverage plugins and Node 22 support; expanded acceptance criteria to include workspace aggregate test script execution. Source: Vitest Release Notes â€“ "Vitest 3.0" (accessed 2025-09-24).
- 2025-09-24: Confirmed npm best practices for capture of lockfile rollback references and dependency dedupe after major upgrades; updated tasks to document rollback tag and run `npm dedupe`. Source: npm Documentation â€“ "Managing package-lock.json" (accessed 2025-09-24).
- Outstanding Risk: Architecture tech stack still references Express 4 until Story 2.4 updates documentation; highlight discrepancy in README changes and follow through on Story 2.4.

## Change Log
| Date       | Version | Description                                      | Author |
|------------|---------|--------------------------------------------------|--------|
| 2025-09-24 | 1.0     | Marked Story 2.1 as complete after final validation and documentation sync. | Codex |
| 2025-09-24 | 0.3     | Implemented Express 5 dependency upgrade, tests, and documentation updates. | James |
| 2025-09-24 | 0.2     | Added research-driven acceptance criteria clarifications and tasks. | Codex |
| 2025-09-24 | 0.1     | Initial draft for Story 2.1 dependency upgrades. | Codex  |

## Dev Agent Record
### Agent Model Used
Codex GPT-5 (dev)

### Debug Log References
- `npm install -w services/mcp-test-server --no-audit --no-fund`
- `npm run build --workspace mcp-test-server`
- `npm run test --workspace mcp-test-server`
- `npm run smoke --workspace mcp-test-server` (with local server)
- `npm run test`
- `npm dedupe --workspaces`
- `npm ls express --workspace mcp-test-server`
- `npm ls @types/express --workspace mcp-test-server`

### Completion Notes List
- Bumped `services/mcp-test-server` dependencies to Express 5.1 / SDK 1.18.1, removed direct `@types/express*`, and regenerated the workspace lockfile (AC1).
- Updated Vitest config to v3 with V8 coverage thresholds and extended Supertest suite to assert auth guard behaviour under Express 5 (AC2, AC3).
- Hardened smoke script to handle event-stream responses and documented Express 5 baseline + rollback hash in README, aligning with Story 2.4 doc follow-up plan (AC3, AC4).
- Ran build/test/smoke workflows and workspace aggregate tests on Node 22; noted residual `@types/express` comes via `mcp-auth-kit` pending Story 2.4 (AC3).
- Reviewed follow-up log and confirmed no additional items are required for Story 2.1 (AC4).

### File List
- package-lock.json
- package.json
- scripts/cloud-test.sh
- services/mcp-test-server/package.json
- services/mcp-test-server/README.md
- services/mcp-test-server/src/smoke.ts
- services/mcp-test-server/test/accept-header.spec.ts
- services/mcp-test-server/vitest.config.ts
- docs/stories/2.1.upgrade-mcp-test-server-deps.md

## QA Results

- 2025-09-24: Traceability matrix recorded at `docs/qa/assessments/2.1-trace-20250924.md` (AC1 partial due to shared `@types/express`; follow-up slated for Story 2.4).
- 2025-09-24: NFR assessment PASS across security/performance/reliability/maintainability (`docs/qa/assessments/2.1-nfr-20250924.md`).
- 2025-09-24: QA gate set to PASS with monitored item for auth-kit Express 4 types (`docs/qa/gates/2.1-upgrade-mcp-test-server-deps.yml`).
