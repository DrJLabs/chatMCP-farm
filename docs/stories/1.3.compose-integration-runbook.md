# Story 1.3: Compose Integration & ChatGPT Runbook

## Status
Done

## Story
**As a** platform engineer onboarding ChatGPT Developer Mode,
**I want** a reproducible compose profile, automated smoke checks, and a connector runbook for the MCP test server,
**so that** we can validate the end-to-end OAuth and transport flow without blocking other services.

## Acceptance Criteria
1. Compose orchestration for `mcp-test-server` documents both CLI (`--profile`) and automation (`COMPOSE_PROFILES`) activation paths, required env files/networks, and keeps the service opt-in under its dedicated profile. [Source: docs/runbooks/compose-and-docs.md#aggregated-compose-workflow-scriptscomposesh] [Source: services/mcp-test-server/compose.yml#L1] [Research: Docker Docs – Use service profiles (accessed 2025-09-22)]
2. A repeatable smoke workflow exercises manifest, protected-resource, and diagnostics endpoints using `scripts/healthcheck.sh` and `npm run smoke`, captures Accept headers (`application/json, text/event-stream`), and records `Mcp-Session-Id` handling guidance for operators. [Source: docs/runbooks/compose-and-docs.md#healthcheck-script-scriptshealthchecksh] [Source: services/mcp-test-server/src/smoke.ts#L1] [Research: Model Context Protocol – Streamable HTTP transport (2025-06-18)]
3. ChatGPT Developer Mode connection steps explain DCR, scope attachment, and post-consent validation, note the required `search` and `fetch` tools, and warn about Developer Mode risk posture. [Source: docs/oauth-keycloak.md#4-validation-playbook] [Source: docs/oauth-keycloak.md#2-keycloak-configuration] [Research: OpenAI Help Center – Connectors in ChatGPT (accessed 2025-09-22)] [Research: Analytics India Mag – OpenAI rolls out Developer Mode (2025-09-11)]
4. README and `.env.example` updates ensure operators map profile variables to Keycloak scope automation, run `scripts/kc/create_mcp_scope.sh`, and include safety callouts for toggling the connector per chat. [Source: docs/bootstrap-checklist.md#bootstrap-steps] [Source: services/mcp-test-server/.env.example#L1] [Research: monday.com Support – Connect monday MCP with ChatGPT (accessed 2025-09-22)]
5. Workspace lint, build, and test scripts (`npm run lint|build|test --workspace mcp-test-server`) pass after documentation updates and confirm Accept header plus `MCP-Protocol-Version` coverage remains green. [Source: docs/architecture/coding-standards.md#coding-standards] [Source: docs/stories/1.2.oauth-manifest-tool-behavior.md#dev-notes] [Research: Model Context Protocol – Streamable HTTP transport (2025-06-18)]

## Tasks / Subtasks
- [x] Validate compose profile inputs and document `--profile` vs `COMPOSE_PROFILES` usage in `docs/runbooks/compose-and-docs.md`, keeping the service opt-in (AC: 1) [Source: docs/runbooks/compose-and-docs.md#aggregated-compose-workflow-scriptscomposesh] [Research: Docker Docs – Use service profiles (accessed 2025-09-22)]
  - [x] Confirm `services/mcp-test-server/compose.yml` references external network/env expectations and add notes for CI usage if missing (AC: 1) [Source: services/mcp-test-server/compose.yml#L1]
- [x] Extend smoke automation to chain `scripts/healthcheck.sh` and `npm run smoke`, capturing Accept header expectations and sample `Mcp-Session-Id` output (AC: 2) [Source: docs/runbooks/compose-and-docs.md#healthcheck-script-scriptshealthchecksh] [Research: Model Context Protocol – Streamable HTTP transport (2025-06-18)]
  - [x] Document token sourcing from `.keycloak-env`, plus required headers (`Accept`, `MCP-Protocol-Version`) in README (AC: 2) [Source: docs/stories/1.2.oauth-manifest-tool-behavior.md#dev-notes]
- [x] Update ChatGPT connector runbook section to cover Developer Mode enablement, `search`/`fetch` requirement, and risk callouts (AC: 3) [Source: docs/oauth-keycloak.md#4-validation-playbook] [Research: OpenAI Help Center – Connectors in ChatGPT (accessed 2025-09-22)]
  - [x] Cross-link Keycloak automation scripts, trusted-host setup, and DCR reminders (AC: 3) [Source: docs/oauth-keycloak.md#23-client-registration-policies]
- [x] Refresh service README and `.env.example` to align with updated runbook, Keycloak scope automation, and per-chat toggle guidance (AC: 4) [Source: docs/bootstrap-checklist.md#bootstrap-steps] [Research: monday.com Support – Connect monday MCP with ChatGPT (accessed 2025-09-22)]
  - [x] Verify instructions remind operators to opt into the profile and clean up via `scripts/compose.sh down` (AC: 4) [Source: docs/runbooks/compose-and-docs.md#aggregated-compose-workflow-scriptscomposesh]
- [x] Run `npm run build`, `npm run lint`, and `npm run test` for the service, confirming Accept header and `MCP-Protocol-Version` assertions remain green (AC: 5) [Source: docs/architecture/coding-standards.md#coding-standards] [Research: Model Context Protocol – Streamable HTTP transport (2025-06-18)]

## Dev Notes
- **Previous Story Insights:** Story 1.2 shipped env-driven manifest metadata, diagnostics token echoing, and documented curl checks; lightweight `search`/`fetch` stubs remain a follow-up. Reuse those diagnostics payloads when defining smoke assertions. [Source: docs/stories/1.2.oauth-manifest-tool-behavior.md#dev-notes]
- **Data Models:** Service remains stateless; smoke workflow consumes JSON-RPC requests without persisting data. No additional data model guidance in architecture docs.
- **API Specifications:** Confirm coverage for `/.well-known/mcp/manifest.json`, `/.well-known/oauth-protected-resource`, `/mcp` POST initialize calls, and diagnostics ping output, ensuring Accept header (`application/json, text/event-stream`) and `MCP-Protocol-Version` guidance stays intact. [Source: services/mcp-test-server/README.md#manual-verification] [Source: docs/oauth-keycloak.md#4-validation-playbook] [Research: Model Context Protocol – Streamable HTTP transport (2025-06-18)]
- **Component Specifications:** Work within `services/mcp-test-server/src/` modules (`server.ts`, `mcp.ts`, `smoke.ts`) and maintain separation between transport wiring and diagnostics logic. [Source: docs/architecture/source-tree.md#source-tree-reference]
- **File Locations:** Compose fragment lives at `services/mcp-test-server/compose.yml`; runbooks reside under `docs/runbooks/`; automation scripts are in `scripts/`. [Source: docs/architecture/source-tree.md#source-tree-reference]
- **Testing Requirements:** Use `scripts/healthcheck.sh` for end-to-end validation and Vitest suites for Accept header and `Mcp-Session-Id` coverage; include token, origin handling, and `MCP-Protocol-Version` header scenarios. [Source: docs/runbooks/compose-and-docs.md#healthcheck-script-scriptshealthchecksh] [Research: Model Context Protocol – Streamable HTTP transport (2025-06-18)]
- **Technical Constraints:** Adhere to TypeScript strict mode, async/await patterns, env validation via `mcp-auth-kit`, and maintain Streamable HTTP as default transport. [Source: docs/architecture/coding-standards.md#coding-standards] [Source: docs/architecture/tech-stack.md#tech-stack]
- **Project Structure Notes:** Updates stay within existing service directories and runbook locations; no structural changes required. [Source: docs/architecture/source-tree.md#source-tree-reference]

## Testing
- Execute `scripts/healthcheck.sh` with `.keycloak-env` credentials followed by `npm run smoke` to validate manifest, PRM, and diagnostics flows, capturing Accept headers, `MCP-Protocol-Version`, and `Mcp-Session-Id` outputs. [Source: docs/runbooks/compose-and-docs.md#healthcheck-script-scriptshealthchecksh] [Research: Model Context Protocol – Streamable HTTP transport (2025-06-18)]
- Run `npm run lint --workspace mcp-test-server`, `npm run build --workspace mcp-test-server`, and `npm run test --workspace mcp-test-server` to confirm regressions remain green. [Source: docs/architecture/coding-standards.md#coding-standards]

## Change Log
| Date       | Version | Description                               | Author |
|------------|---------|-------------------------------------------|--------|
| 2025-09-22 | 0.3     | Added compose profile guardrails, secret lint, and smoke automation logging; refreshed Developer Mode guidance. | James  |
| 2025-09-22 | 0.2     | Research validation pass completed; AC/tasks updated for Streamable HTTP + Developer Mode guidance. | Dr. Evelyn |
| 2025-09-22 | 0.1     | Initial draft generated by Scrum Master.  | Bob    |

## Dev Agent Record
### Agent Model Used
Codex GPT-5 (dev)

### Debug Log References
- npm run build --workspace mcp-test-server
- npm run test --workspace mcp-test-server
- npm run lint

### Completion Notes List
- Documented compose profile activation paths in `docs/runbooks/compose-and-docs.md` and annotated `services/mcp-test-server/compose.yml` for CI usage, keeping the service opt-in.
- Extended smoke tooling (`scripts/healthcheck.sh`, `src/smoke.ts`) and README guidance to surface `Accept`, `Mcp-Session-Id`, and `Mcp-Protocol-Version` details for operators.
- Updated ChatGPT Developer Mode runbook, README, and `.env.example` with secret-handling, trusted-host reminders, and per-chat toggle guidance; added build tooling (`tsconfig.build.json`) for clean TypeScript output.
- Added guardrails (`scripts/check-inline-secrets.mjs`, `scripts/check-compose-profile.sh`, `scripts/run-guardrails.sh`) and wired them into `npm test` / `npm run guard` to enforce secret sourcing and compose opt-in checks.

### File List
- docs/oauth-keycloak.md
- docs/runbooks/compose-and-docs.md
- scripts/healthcheck.sh
- docs/qa/assessments/1.3-po-validation-20250922.md
- docs/qa/assessments/1.3-risk-20250922.md
- docs/qa/assessments/1.3-test-design-20250922.md
- services/mcp-test-server/.env.example
- services/mcp-test-server/README.md
- services/mcp-test-server/compose.yml
- services/mcp-test-server/package.json
- services/mcp-test-server/src/app.ts
- services/mcp-test-server/src/mcp.ts
- services/mcp-test-server/src/smoke.ts
- services/mcp-test-server/test/accept-header.spec.ts
- services/mcp-test-server/tsconfig.build.json
- scripts/check-compose-profile.sh
- scripts/check-inline-secrets.mjs
- scripts/run-guardrails.sh

### DoD Checklist
- [x] Requirements Met – All acceptance criteria satisfied via documentation updates, header logging, and automated tests.
- [x] Coding Standards – Changes align with TypeScript strict mode and repo standards; lint aggregate succeeded.
- [x] Testing – `npm run test --workspace mcp-test-server` executed updated Vitest coverage (headers + diagnostics).
- [x] Functionality & Verification – Healthcheck + smoke scripts now emit required header metadata; compose dry-run documented.
- [x] Story Administration – Story tasks marked complete; Dev Agent Record populated.
- [x] Dependencies & Build – Dedicated `tsconfig.build.json` ensures clean build output; `npm run build --workspace mcp-test-server` succeeded.
- [x] Documentation – Runbook, README, `.env.example`, and OAuth guide refreshed with Developer Mode + secret guidance.
- [x] I confirm all applicable DoD items have been addressed.

## QA Results
- Risk profile logged at `docs/qa/assessments/1.3-risk-20250922.md` (High risks: 0; overall score 85/100 after guardrails).
- Test design matrix stored at `docs/qa/assessments/1.3-test-design-20250922.md` (8 scenarios, 4 P0, coverage gaps: none).
- Traceability matrix published at `docs/qa/assessments/1.3-trace-20250922.md` (coverage: 3 full, 2 partial; remaining gaps for Developer Mode staging + doc lint).
- NFR assessment recorded at `docs/qa/assessments/1.3-nfr-20250922.md` (all attributes PASS post-guardrails).
- QA gate archived at `docs/qa/gates/1.3-compose-integration-runbook.yml` (PASS with guardrails enforced via `npm run guard`).

## 🔬 Research & Validation Log
- 2025-09-22: Reviewed Docker Compose profile guidance to ensure story documents `--profile` and `COMPOSE_PROFILES` usage pathways for opt-in services. [Research: Docker Docs – Use service profiles (accessed 2025-09-22)]
- 2025-09-22: Validated MCP Streamable HTTP transport requirements for Accept headers, `MCP-Protocol-Version`, and `Mcp-Session-Id` handling to bake into smoke workflow tasks. [Research: Model Context Protocol – Streamable HTTP transport (2025-06-18)]
- 2025-09-22: Confirmed ChatGPT Developer Mode rollout details, required `search`/`fetch` tools, and associated risk guidance for runbook warnings. [Research: Analytics India Mag – OpenAI rolls out Developer Mode (2025-09-11)] [Research: OpenAI Help Center – Connectors in ChatGPT (accessed 2025-09-22)]
- 2025-09-22: Captured monday.com connector verification workflow as a practical OAuth validation example for operators. [Research: monday.com Support – Connect monday MCP with ChatGPT (accessed 2025-09-22)]
