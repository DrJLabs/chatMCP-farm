# Story 1.1: Scaffold MCP Test Server Service

## Status
Done

## Story
**As a** platform engineer responsible for MCP infrastructure,
**I want** a scaffolded `mcp-test-server` service with baseline Express and MCP wiring,
**so that** we can extend the workspace with an isolated test target for OAuth and ChatGPT verification.

## Acceptance Criteria
1. Service scaffold exists under `services/mcp-test-server` using the standard template layout.
2. Environment configuration (`.env.example`, `README`) documents required OAuth variables without leaking secrets.
3. Docker Compose fragment matches the workspace aggregation conventions, remains opt-in, and introduces resource limits to avoid starving existing services.
4. Basic TypeScript entrypoint boots an Express server with `@modelcontextprotocol/sdk` registration using placeholder tool.
5. Local npm scripts build and lint cleanly alongside existing workspaces.
6. Streamable HTTP transport defaults to localhost binding, enforces an Origin allow-list configurable via environment variables, and documents override scenarios for future cross-origin integrations.

## Tasks / Subtasks
- [x] Copy `templates/service` scaffold into `services/mcp-test-server` and update package metadata (AC: 1, 5)
  - [x] Set `name`, `description`, and workspace settings in `package.json`
  - [x] Configure `tsconfig.json` to extend `../../tsconfig.base.json`
- [x] Prepare environment templates (AC: 2, 6)
  - [x] Create `.env.example` with placeholders for `KEYCLOAK_REALM`, `OIDC_ISSUER`, `OIDC_AUDIENCE`, and `MCP_ALLOWED_ORIGINS`
  - [x] Reference `.keycloak-env.example` in `README.md` and document secret management expectations
  - [x] Note that client-credentials flow is assumed; manifest Auth Code + PKCE decision lands in Story 1.2
- [x] Add Compose integration (AC: 3)
  - [x] Copy `compose.yml`, update service name, ports, depends_on, and add CPU/memory limits per workspace conventions
  - [x] Ensure snippet stays opt-in via `scripts/compose.sh` flagging and document enablement steps
- [x] Implement baseline server entrypoint (AC: 4, 6)
  - [x] Wire Express app with `mcp-auth-kit` middleware and register placeholder tool returning static payload
  - [x] Bind server to `process.env.MCP_BIND_HOST ?? '127.0.0.1'` and reject requests with disallowed `Origin` headers before hitting MCP handler
  - [x] Include startup logging aligned with coding standards, noting active host/port and allowed origins
- [x] Update workspace configuration (AC: 5)
  - [x] Register service in root `package.json` workspaces if needed
  - [x] Add npm scripts (`lint`, `build`, `start`) mirroring the service template
  - [x] Verify `npm run lint --workspaces --if-present` passes
- [x] Author initial `README.md` usage notes (AC: 2, 6)
  - [x] Document OAuth client setup expectations in Keycloak, including confidential client settings, redirect URI scope, and example `MCP_ALLOWED_ORIGINS` (e.g., `http://127.0.0.1:3333`)
  - [x] Outline local smoke test workflow once scripts land in later stories and note that smoke script implementation is deferred to Story 1.3

## Dev Notes
- **Project structure reference:** New services belong under `services/<name>` with their own `package.json`, Dockerfile, and compose snippet, matching the documented tree. [Source: docs/architecture/source-tree.md]
- **Runtime & stack alignment:** Use Node.js 24.x with Express 4, `@modelcontextprotocol/sdk`, and local `mcp-auth-kit` to remain consistent with existing services. [Source: docs/architecture/tech-stack.md]
- **Coding standards:** Enable strict TypeScript, prefer async/await, validate env variables through shared config, default to Streamable HTTP transport, and keep controllers transport-agnostic. [Source: docs/architecture/coding-standards.md]
- **Transport security:** Streamable HTTP servers should bind to localhost by default, validate `Origin` headers, and treat session identifiers as cryptographically strong tokens. Provide env toggles so future stories can expand the allow-list safely. [Reference: Model Context Protocol Transports specification, revision 2025-06-18]
- **OAuth alignment:** Use a confidential Keycloak client with service-account enabled for server-to-server token exchange; document redirect URIs/Web Origins even if unused yet, and point devs to `.keycloak-env.example` for actual secret loading. Story 1.1 proceeds with client-credentials only; Auth Code + PKCE evaluation happens in Story 1.2. [Reference: Keycloak Securing Applications and Services Guide 25.0.5]
- **Compose hygiene:** Apply memory/CPU limits in the compose snippet to avoid starving Keycloak and other containers during local runs; keep secrets externalized via env files. [Reference: ConfigZen Keycloak Docker Compose pitfalls, 2025-03]
- **Testing posture:** Provide smoke scripts for the MCP test server (Story 1.3) to ensure parity with Streamable HTTP expectations. Note that implementation defers to Story 1.3; keep placeholders minimal here. [Source: docs/architecture/tech-stack.md]
- **Previous Story Insights:** None; this is the first story in the epic.
- **Data Models:** No persistent storage required for scaffold.
- **API Specifications:** Expose manifest endpoint and placeholder MCP tool; concrete behaviour deferred to Story 1.2.
- **Component Specifications:** Not applicable (CLI/server only).
- **File Locations:**
  - `services/mcp-test-server/src/server.ts` for Express bootstrap.
  - `services/mcp-test-server/src/mcp.ts` for tool registration mirroring the service template. [Source: docs/architecture/source-tree.md]
- **Testing Requirements:** Maintain lint/test parity with workspace scripts; add smoke scripts in subsequent stories.
- **Technical Constraints:** Keep performance impact minimal and avoid altering existing APIs. [Source: docs/architecture/coding-standards.md]

### Testing
- Place future smoke scripts under `services/mcp-test-server/src/` following the emerging test-server pattern. [Source: docs/architecture/source-tree.md]
- Use Node smoke scripts with Streamable HTTP transport as the default validation workflow, and extend with Origin-binding assertions once tool endpoints exist. [Source: docs/architecture/tech-stack.md]

## ðŸ”¬ Research & Validation Log
- 2025-09-21: Reviewed MCP Streamable HTTP transport guidance (revision 2025-06-18) to enforce localhost binding, Origin validation, and secure session IDs for the scaffold. [Model Context Protocol Transports Spec]
- 2025-09-21: Consulted Keycloak 25.0.5 Securing Applications guide to ensure confidential client usage and env-managed credential placeholders in the scaffold documentation. [Keycloak Securing Applications and Services Guide]
- 2025-09-21: Noted Docker Compose resource-allocation recommendations to guard against Keycloak starvation; task list now mandates CPU/memory limits in the new snippet. [ConfigZen â€“ Common Pitfalls When Setting Up Keycloak with Docker Compose]
- 2025-09-21: Confirmed Story 1.1 proceeds with Keycloak client-credentials flow; defer Authorization Code + PKCE evaluation to Story 1.2 and track dependency in Change Log.
- Open question: determine preferred CI runner for compose smoke tests (local vs. containerized) before wiring automation.

## Change Log
| Date       | Version | Description                                              | Author |
|------------|---------|----------------------------------------------------------|--------|
| 2025-09-21 | 0.6     | Executed planned test scenarios; updated compose profile defaults for docker compose validation. | Codex  |
| 2025-09-21 | 0.5     | Final QA trace + NFR complete; PO approval recorded, status set to Done. | Codex  |
| 2025-09-21 | 0.4     | Implemented service scaffold, compose profile, and diagnostics tool; ran lint/build. | Codex  |
| 2025-09-21 | 0.3     | Addressed PO follow-ups (OAuth flow note, smoke deferral, origin examples). | Codex  |
| 2025-09-21 | 0.2     | Researcher validation updates and security guidance.     | Codex  |
| 2025-09-21 | 0.1     | Initial draft created for Story 1.1 scaffold.            | Codex  |

## Dev Agent Record
### Agent Model Used
Codex GPT-5 (dev)

### Debug Log References
- npm run lint --workspaces --if-present
- npm run build --workspaces --if-present

### Completion Notes List
- Scaffolded `services/mcp-test-server` from template and updated package metadata, TypeScript config, and Dockerfile for Node.js 24 + port 8770.
- Implemented diagnostics-focused MCP server with localhost binding, origin enforcement, and deterministic tool output.
- Added opt-in compose profile with CPU/memory limits plus `.env.example` + README documenting OAuth setup and smoke deferral.

### File List
- services/mcp-test-server/package.json
- services/mcp-test-server/tsconfig.json
- services/mcp-test-server/src/server.ts
- services/mcp-test-server/src/mcp.ts
- services/mcp-test-server/src/smoke.ts
- services/mcp-test-server/compose.yml
- services/mcp-test-server/.env.example
- services/mcp-test-server/README.md
- services/mcp-test-server/Dockerfile

## QA Results
- Test evidence: manual curl runs confirm root + manifest (200), initialize/tool call succeed with session header; malicious origin blocked with 403.
- Compose config validated via `docker compose -f services/mcp-test-server/compose.yml config` (with local env overrides).
- Env validation: `loadServiceEnvConfig` normalizes OAuth URLs and origin defaults (node script).
- Trace matrix: docs/qa/assessments/1.1-trace-20250921.md
- NFR assessment: docs/qa/assessments/1.1-nfr-20250921.md
- Risk profile: docs/qa/assessments/1.1-risk-20250921.md
- Test design: docs/qa/assessments/1.1-test-design-20250921.md
- PO final validation: docs/qa/assessments/1.1-po-validation-final-20250921.md
