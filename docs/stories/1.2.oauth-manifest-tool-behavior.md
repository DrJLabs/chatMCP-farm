# Story 1.2: Implement OAuth Manifest & Diagnostics Behaviour

## Status
Done

## Story
**As a** platform engineer validating ChatGPT Developer Mode connectors,
**I want** the MCP test server to expose fully populated OAuth metadata and practical diagnostics tools,
**so that** I can confirm end-to-end auth, manifest discovery, and token audiences before real clients connect.

## Acceptance Criteria
1. `/.well-known/mcp/manifest.json` returns names, descriptions, transport metadata, and tool listings sourced from env config, and the Streamable HTTP entry matches `MCP_PUBLIC_BASE_URL`.
2. `/.well-known/oauth-protected-resource` and `/` advertise the canonical resource URL and emit `WWW-Authenticate` when auth is enforced, without breaking Story 1.1 origin checks.
3. Unauthorized requests to `/mcp` still set challenge headers and respond with deterministic JSON errors while preserving Accept-header validation.
4. `diagnostics.ping` echoes token claim summaries (subject, audiences, expiry where available), request origin, and timestamp, remaining safe to call without secrets.
5. README and `.env.example` document the new diagnostics payload and include copy/paste `curl` checks for manifest, PRM, and authenticated diagnostics calls.
6. Regression: lint/build scripts from Story 1.1 continue to pass, and compose profile stays opt-in with no extra env required beyond the documented additions.
7. Implement lightweight `search` and `fetch` stubs (or explicitly document a follow-up) so the manifest remains compatible with ChatGPT guidance without interfering with diagnostics tooling.

## Tasks / Subtasks
- [x] Re-read Story 1.1 Dev Agent Record to capture deferred auth/diagnostics notes and confirm no conflicting changes (AC: 7) [Source: docs/architecture/source-tree.md#source-tree-reference]
- [x] Update `authKit` manifest configuration so human/model names, descriptions, capabilities, and transport entries pull entirely from env values (AC: 1) [Source: docs/architecture/tech-stack.md#tech-stack]
- [x] Ensure PRM handler and root endpoint emit `WWW-Authenticate` when `requireAuth` is true and keep origin filtering intact (AC: 2, 3) [Source: docs/architecture/coding-standards.md#coding-standards]
- [x] Extend diagnostics tool in `services/mcp-test-server/src/mcp.ts` to derive JWT claims from the auth context and include origin/timestamp metadata in responses (AC: 4) [Source: docs/architecture/source-tree.md#source-tree-reference]
- [x] Add README section with minimal operator workflow: manifest/PRM curl checks, token acquisition, and diagnostics call, noting whether the lightweight `search`/`fetch` stubs are enabled and how to exercise them (AC: 5, 7) [Source: docs/architecture/tech-stack.md#tech-stack]
- [x] Build and validate the `search`/`fetch` stubs (simple passthrough tooling is acceptable) or log the follow-up task with owner/date in `docs/stories/follow-ups.md` if intentionally deferred (AC: 7)
- [x] Run `npm run lint --workspaces --if-present` and targeted smoke commands (manifest + diagnostics curl) to verify no regressions (AC: 3, 6) [Source: docs/architecture/coding-standards.md#coding-standards]

## Dev Notes
- **Previous Story Insights:** Story 1.1 left manifest strings and diagnostics payload minimal; this story expands those surfaces without altering deployment paths.
- **Data Models:** Still stateless; diagnostics returns derived token data and metadata only. No specific guidance found in architecture docs.
- **API Specifications:** Streamable HTTP transport must honor Accept-header and origin validation; manifest/PRM responses should reflect MCP spec defaults and reference env-driven values. [Spec: MCP Transports, 2025-06-18]
- **Component Specifications:** Backend-only; ensure new manifest helper lives alongside existing `mcp-auth-kit` wiring. No specific guidance found in architecture docs.
- **File Locations:** Updates focus on `services/mcp-test-server/src/server.ts`, `services/mcp-test-server/src/mcp.ts`, and `services/mcp-test-server/README.md`. [Source: docs/architecture/source-tree.md#source-tree-reference]
- **Testing Requirements:** Use local curl scripts to confirm manifest/PRM and authenticated diagnostics flows. OpenAI guidance still recommends exposing `search` and `fetch` tools for broad connector compatibility; shipping lightweight stubs keeps us aligned without depending on undocumented behaviour. [OpenAI Developer Mode connector guidance, 2025-09] [OpenAI Developer Mode release guidance, 2025-09]
- **Technical Constraints:** Maintain strict TypeScript, async/await usage, env validation via `mcp-auth-kit`, and keep compose profile opt-in to avoid surprising other services. [Source: docs/architecture/coding-standards.md#coding-standards]

## Project Structure Notes
No conflicts with the defined service layout. [Source: docs/architecture/source-tree.md#source-tree-reference]

## Testing
- Use documented curl snippets to request manifest, PRM, and diagnostics endpoints with and without tokens, confirming consistent challenge headers and deterministic responses. [Spec: MCP Transports, 2025-06-18]

## ðŸ”¬ Research & Validation Log
- 2025-09-22: Reviewed MCP Streamable HTTP transport spec (revision 2025-06-18) to reinforce Accept-header enforcement and origin validation requirements. Source: Model Context Protocol specification (accessed 2025-09-22).
- 2025-09-22: Revalidated OpenAI ChatGPT Developer Mode guidance noting `search`/`fetch` tools are recommended but not currently enforced; logged follow-up to implement stubs without blocking story delivery. Source: OpenAI Help Center â€“ Connectors in ChatGPT (updated September 2025).
- Open risk: Deferring the stubs could lead to inconsistent experiences if OpenAI enforces the recommendation; log and monitor if we choose to defer.

## Dev Agent Record
### Agent Model Used
Codex GPT-5 (dev)

### Debug Log References
- npm run lint --workspaces --if-present
- npm run test --workspace mcp-test-server

### Completion Notes List
- Refactored server bootstrap into `src/app.ts` so manifest/PRM handlers expose env-driven metadata and challenge headers while keeping the existing entrypoint intact.
- Enhanced `diagnostics.ping` to decode verified JWT claims safely and report origin/timestamp data; added Vitest unit coverage for the formatter and Supertest integration checks for HTTP metadata endpoints.
- Documented the curl-based verification workflow and updated `.env.example` plus follow-up log to cover deferred `search`/`fetch` stubs.

### File List
- package-lock.json
- docs/stories/follow-ups.md
- docs/qa/assessments/1.2-po-validation-20250922.md
- docs/qa/assessments/1.2-risk-20250922.md
- docs/qa/assessments/1.2-test-design-20250922.md
- services/mcp-test-server/.env.example
- services/mcp-test-server/README.md
- services/mcp-test-server/package.json
- services/mcp-test-server/src/app.ts
- services/mcp-test-server/src/config.ts
- services/mcp-test-server/src/mcp.ts
- services/mcp-test-server/src/server.ts
- services/mcp-test-server/test/diagnostics.spec.ts
- services/mcp-test-server/test/manifest.spec.ts
- services/mcp-test-server/tsconfig.json
- services/mcp-test-server/vitest.config.ts

### DoD Checklist
- [x] Requirements Met â€“ Acceptance criteria validated via Vitest + Supertest coverage; stub tooling deferred with documented follow-up.
- [x] Coding Standards â€“ Changes follow existing TypeScript, logging, and env validation patterns; no lint warnings introduced.
- [x] Testing â€“ Added targeted unit/integration tests and executed `npm run test --workspace mcp-test-server`.
- [x] Functionality & Verification â€“ Manifest/PRM/diagnostics flows verified through automated Supertest requests covering documented curl workflow.
- [x] Story Administration â€“ Story tasks updated, Dev Agent Record filled, follow-up logged.
- [x] Dependencies & Build â€“ Workspace builds/lint succeed; new dev dependencies (`vitest`, `supertest`, `@types/supertest`) recorded in package.json/package-lock.json.
- [x] Documentation â€“ README and `.env.example` revised with new verification steps; follow-up file updated for future stubs.
- [x] I confirm all applicable DoD items have been addressed.

## Change Log
| Date       | Version | Description                                                                  | Author |
|------------|---------|------------------------------------------------------------------------------|--------|
| 2025-09-22 | 0.2     | Added Supertest Accept-header regression; QA gate set to PASS with stub follow-up logged. | James  |
| 2025-09-22 | 0.1     | Initial implementation of Story 1.2 manifest/diagnostics updates.           | James  |

## QA Results
- Traceability matrix logged at `docs/qa/assessments/1.2-trace-20250922.md` (5/7 ACs fully covered; AC5 remains manual doc workflow and AC7 tracked via follow-up).
- NFR assessment (`docs/qa/assessments/1.2-nfr-20250922.md`) now PASS across attributes after adding Accept-header regression test.
- Gate file `docs/qa/gates/1.2-oauth-manifest-tool-behavior.yml` now PASS; only remaining action is the planned search/fetch stub follow-up.
