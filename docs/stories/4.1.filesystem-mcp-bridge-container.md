# Story 4.1: Filesystem MCP Bridge Container

## Status
Done

## Story
**As a** platform engineer maintaining the MCP farm,
**I want** a containerized `rust-mcp-filesystem` bridge image with an SSE proxy entrypoint,
**so that** we can expose `/projects` and `/VAULTS` to MCP clients without requiring GitHub credentials.

## Acceptance Criteria
1. `services/filesystem-mcp/Bridge.Dockerfile` implements a multi-stage build using `rust:1.89-bookworm`, installs build prerequisites, clones `rust-mcp-filesystem` at commit `b3c000a03dd8d70795335c291cb46866f5f42fd3` (override via build arg), and produces a stripped release binary copied into the runtime stage. [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#enhancement-details] [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#risk-mitigation] [Source: docs/architecture/tech-stack.md#containerization]
2. Runtime stage uses `debian:bookworm-slim`, installs `python3-pip`, adds `mcp-proxy==0.9.0` via `pip install --no-cache-dir`, copies the release binary to `/usr/local/bin/rust-mcp-filesystem`, and ensures layer cleanup to keep the final image lean while exposing the pinned proxy version in an image label. [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#enhancement-details] [Source: docs/architecture/tech-stack.md#containerization]
3. An entrypoint script at `/usr/local/bin/entrypoint.sh` parses `FS_ALLOWED` (default `/projects:/VAULTS`) into positional arguments, rejects empty or root-only configurations with a non-zero exit + log message, forwards `ALLOW_WRITE=true` as `--allow-write` and `ENABLE_ROOTS=true` as `--enable-roots`, uses `SSE_PORT` default `12010`, and launches `mcp-proxy --sse-port "${PORT}" -- /usr/local/bin/rust-mcp-filesystem "${roots[@]}"`. [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#enhancement-details] [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#notes]
4. Final image exposes port `12010`, declares the entrypoint script via `ENTRYPOINT`, and documents expected environment variables (`FS_ALLOWED`, `ALLOW_WRITE`, `ENABLE_ROOTS`, `SSE_PORT`) inside the Dockerfile comments for downstream reference. [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#success-criteria] [Source: docs/architecture/source-tree.md#services]
5. A build validation note is added to the Dev Notes describing how to confirm the image with `docker build -f services/filesystem-mcp/Bridge.Dockerfile .` and a sample `docker run --rm` invocation that lists allowed roots, ensuring the entrypoint wiring is demonstrable. [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#definition-of-done] [Source: TESTING.md]

## Tasks / Subtasks
- [x] Author `services/filesystem-mcp/Bridge.Dockerfile` with multi-stage build, pinned commit checkout, and release binary copy. (AC: 1) [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#enhancement-details]
  - [x] Introduce build arg `FILESYSTEM_MCP_REF` defaulting to `b3c000a03dd8d70795335c291cb46866f5f42fd3`, document update procedure, and pin builds with `cargo build --release --locked` for reproducibility. (AC: 1) [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#risk-mitigation]
  - [x] Strip the release binary and remove build toolchain packages in the runtime stage. (AC: 1,2) [Source: docs/architecture/tech-stack.md#containerization]
- [x] Install `mcp-proxy==0.9.0` in runtime stage, expose the version via `LABEL org.opencontainers.image.version`, and ensure Python/pip caches are cleaned. (AC: 2) [Source: docs/architecture/tech-stack.md#containerization]
- [x] Add CI smoke script that runs `docker run --rm --entrypoint mcp-proxy filesystem-mcp-bridge:TAG --version` and fails if the pinned version is missing. (AC: 2) [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#definition-of-done]
- [x] Create `/usr/local/bin/entrypoint.sh` enforcing `set -euo pipefail`, parsing `FS_ALLOWED`, and mapping write/root toggles to CLI flags while rejecting empty/root-only configurations with actionable error messaging. (AC: 3) [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#notes]
  - [x] Include shellcheck-friendly quoting and unit-testable functions (e.g., support empty roots with fallback). (AC: 3) [Source: docs/architecture/coding-standards.md#coding-standards]
- [x] Document `ALLOW_WRITE` enablement workflow requiring PO/QA sign-off before toggling to true; add warning banner in Dockerfile comments. (AC: 3,4) [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#risk-mitigation]
- [x] Configure `EXPOSE 12010`, set `ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]`, and comment supported environment variables. (AC: 4) [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#success-criteria]
- [x] Document verification commands in Dev Notes and capture sample output from `docker run --rm` demonstrating root arguments and SSE port binding. (AC: 5) [Source: TESTING.md]

## Dev Notes
- **Epic alignment:** This story produces the bridge image required before compose wiring in Story 4.2; keep runtime defaults read-only (`ALLOW_WRITE=false`, `ENABLE_ROOTS=false`) to match the epic’s security stance. [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#enhancement-details] [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#risk-mitigation]
- **Project structure:** Place Docker artefacts under `services/filesystem-mcp/` to mirror existing service conventions. [Source: docs/architecture/source-tree.md#services]
- **Containerization standards:** Use multi-stage builds, remove build deps from runtime, keep images minimal, and pin `mcp-proxy` to 0.9.0 with a corresponding image label plus smoke check. [Source: docs/architecture/tech-stack.md#containerization]
- **Env naming parity:** Reuse `FS_ALLOWED`, `ALLOW_WRITE`, `ENABLE_ROOTS`, and `SSE_PORT` so subsequent compose profile and `.env` files stay consistent with other MCP bridges. [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#enhancement-details]
- **Security defaults:** Default to read-only mounts, require explicit opt-in for writes, and fail fast when `FS_ALLOWED` is empty or points to root; document the approval workflow before enabling writes. [Source: docs/bmad/focused-epics/filesystem-mcp/epic.md#risk-mitigation]
- **Testing prompt:** After building the image, run `docker run --rm -e FS_ALLOWED=/tmp -e SSE_PORT=12010 filesystem-mcp-bridge:local` and confirm the process starts with expected arguments; capture this as evidence in Dev Agent Record. Also run `scripts/filesystem-mcp-bridge-smoke.sh filesystem-mcp-bridge:local` to assert the pinned proxy version and guardrail failure path. [Source: TESTING.md]
- **Previous story insights:** None—first story for this epic.

## Testing
- Execute `docker build -f services/filesystem-mcp/Bridge.Dockerfile -t filesystem-mcp-bridge:local .` to ensure the build completes without network access beyond cloning the pinned commit. [Source: TESTING.md]
- Run `docker run --rm -e FS_ALLOWED=/projects:/VAULTS filesystem-mcp-bridge:local` and observe startup logs showing the allowed roots and SSE port before stopping the container to confirm the entrypoint wiring. [Source: TESTING.md]
- Validate the pinned proxy version and guardrail behaviour via `scripts/filesystem-mcp-bridge-smoke.sh filesystem-mcp-bridge:local`. [Source: TESTING.md]

## Change Log
| Date       | Version | Description                                           | Author |
|------------|---------|-------------------------------------------------------|--------|
| 2025-09-25 | 1.0     | Story completed; bridge image, docs, and QA validated | Sarah |

## Dev Agent Record
### Agent Model Used
- GPT-5 (Codex CLI Dev Agent)

### Debug Log References
- `scripts/filesystem-mcp-bridge-smoke.sh` run (see Testing Evidence)

### Completion Notes List
- Built `filesystem-mcp-bridge:local` image with pinned `mcp-proxy` 0.9.0.
- Ran `docker run --rm -e FS_ALLOWED=/tmp filesystem-mcp-bridge:local` to observe bridge startup (terminated after log verification) and confirmed empty `FS_ALLOWED` exits non-zero.
- Smoke script validated version string and guardrail failure path.

### File List
- services/filesystem-mcp/Bridge.Dockerfile
- scripts/filesystem-mcp-bridge-smoke.sh
## PO Notes
- 2025-09-25 — Sarah (Product Owner): Final validation complete. Automated smoke script now covers SSE port readiness and documentation drift, all acceptance criteria (AC1-AC5) fully satisfied. Story marked Ready for Review.
- 2025-09-25 — Sarah (Product Owner): Reviewed Story 4.1 against the filesystem MCP epic scope. Acceptance criteria cover bridge image build, runtime proxy wiring, entrypoint safeguards, and validation guidance. Flagged QA CONCERNS for `FS_ALLOWED` guardrails and `mcp-proxy` pinning as pre-implementation risks; once mitigations are planned alongside the new integration test, story remains approved for development.
- 2025-09-25 — Sarah (Product Owner): Revalidated after QA updates to confirm the additional integration test (4.1-INT-005) and gate refresh. With acceptance criteria now covering entrypoint guardrails and pinned `mcp-proxy` version, story is approved for implementation once dev picks it up.

## QA Results

- 2025-09-25 — Quinn (Test Architect): Risk profile updated post-implementation (`docs/qa/assessments/4.1-risk-20250925.md`) showing SEC-001 and TECH-001 reduced to low probability after guardrails + pinning; OPS-001 remains medium with monitoring.
- 2025-09-25 — Quinn (Test Architect): Produced test design matrix (`docs/qa/assessments/4.1-test-design-20250925.md`) with 8 scenarios (four P0 covering entrypoint parsing/build determinism plus integration/E2E coverage for runtime validation).
- Quality Gate: PASS (`docs/qa/gates/4.1-filesystem-mcp-bridge-container.yml`) with monitoring note for host directory readiness.
