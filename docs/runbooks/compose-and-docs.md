# Compose & Docs Runbook

**Version:** 0.1.0  
**Last Updated:** September 20, 2025  
**Owner:** Platform Engineering (chat-mcp-farm)

---

## Purpose
Provide a quick reference for operating the shared automation scripts that (a) assemble the local docker-compose stack across MCP services, (b) render documentation with environment-specific overlays, and (c) keep BMAD agents aligned with the required activation flow.

---

## Prerequisites
- Node.js 24.x (pre-LTS, October 2025 promotion expected) with npm workspaces installed (`npm install` at repo root).
- Docker/Compose v2 available on PATH.
- `.keycloak-env` populated with service-account credentials for Keycloak automation scripts.
- Per-service `.env` files copied from the associated `.env.example` templates.
- Optional doc overrides stored under `docs/local/` (ignored by git).

---

## Aggregated Compose Workflow (`scripts/compose.sh`)
1. **Bootstrap services**
   ```bash
   scripts/bootstrap.sh <service-name>
   ```
   - Copies `templates/service` into `services/<service-name>` and wires default compose fragment.
2. **Enroll the service in Compose**
   - Ensure `services/<service-name>/compose.yml` exists (generated by the template).
   - Confirm env file is in place: `services/<service-name>/.env`.
3. **Start the stack**
   ```bash
   scripts/compose.sh up --build
   ```
   - Discovers every `services/*/compose.yml` plus the root `docker-compose.yml` and forwards arguments directly to `docker compose`.
   - Add `-d` for detached runs; pass service names to limit scope (`scripts/compose.sh up --build mcp-test-server`).
4. **Tear down**
   ```bash
   scripts/compose.sh down --remove-orphans
   ```
   - Removes only containers started by the aggregated stack. External networks defined in `.env` remain untouched.
5. **Logs & inspection**
   ```bash
   scripts/compose.sh logs -f mcp-test-server
   scripts/compose.sh ps
   ```
   - Use standard docker-compose flags; the wrapper simply composes the file list.

> **Tip:** When adding a new service, run `scripts/kc/create_mcp_scope.sh --resource <MCP_PUBLIC_BASE_URL>` before starting the stack to register Keycloak scopes.

---

## Documentation Rendering Pipeline (`scripts/render-docs.mjs`)
1. **Configure overrides**
   - Copy `docs/config.sample.json` to `docs/local/config.local.json` and adjust values (realm, hosts, scope names).
   - Additional environment-specific config files can be stored under `docs/local/*.json`; list them in `config.local.json` via the `overrides` array.
2. **Render docs**
   ```bash
   npm run docs:render
   ```
   - Invokes `scripts/render-docs.mjs`, applying overrides and saving populated copies to `docs/.generated/` (paths declared in `docs/config.sample.json`).
   - Source markdown retains templated placeholders (`{{VAR}}`); generated copies should never be committed.
3. **Validate outputs**
   - Inspect files under `docs/.generated/` to confirm substitution.
   - For CI/local smoke checks you can diff the generated copy against expectations.
4. **Housekeeping**
   - Delete stale artifacts with `rm -rf docs/.generated/*` when regenerating from scratch.
   - Keep `docs/config.sample.json` updated when new templated docs or variables are introduced.

---


## Healthcheck Script (`scripts/healthcheck.sh`)
1. **Basic usage**
   ```bash
   CLIENT_ID="$CLIENT_ID" CLIENT_SECRET="$CLIENT_SECRET" \
   scripts/healthcheck.sh \
     --base-url https://memory.example.com/mcp \
     --issuer https://keycloak.example.com/realms/OMA \
     --sse
   ```
   - Reads defaults from `MCP_TRANSPORT_URL` (falls back to `MCP_PUBLIC_BASE_URL`), `KC_ISSUER`, `CLIENT_ID`, and `CLIENT_SECRET` when flags are omitted. `PRM_RESOURCE_URL` overrides the derived protected resource URL when set.
   - Requires `jq` and `curl` on PATH.
   - Prefer environment variables for `CLIENT_SECRET` to avoid exposing credentials via `ps`/shell history; the script logs a warning when the flag is used.
2. **Checks performed**
   - Manifest availability and schema version (`.well-known/mcp/manifest.json`).
   - Protected resource metadata (`.well-known/oauth-protected-resource`).
   - Client-credential token issuance against the Keycloak issuer.
   - Streamable HTTP `initialize` call verifying `Mcp-Session-Id` header.
   - Optional SSE HEAD probe when `--sse` is supplied.
3. **Exit codes**
   - Returns `0` on success, non-zero on first failure with error output.
   - Script cleans up temporary files automatically.

---

## Agent Activation Expectations
1. **BMAD Workflow**
   - All agents load `.bmad-core/core-config.yaml` during activation; ensure any new runbook or script gets reflected in the appropriate tasks/templates.
   - After running BMAD workflows, append updates to BMAD documentation and story records as dictated by `AGENTS.md`.
2. **Developer Agent Checklist**
   - Before coding, load `docs/architecture/tech-stack.md`, `docs/architecture/source-tree.md`, and `docs/architecture/coding-standards.md` (reinforced in `AGENTS.md`).
   - Reference this runbook when tasks involve local compose orchestration or documentation rendering.
3. **Documentation Logging**
   - Record substantive decisions via `openmemory.add_memories` (legacy reference; continue to tag decisions with the test server context) with `project=chat-mcp-farm` tags (see `AGENTS.md` Turn Lifecycle).
   - Include links to generated artifacts (e.g., `docs/.generated/...`) instead of embedding raw content.

---

## References
- `PROJECT_SPLIT_PLAN.md` – roadmap items referencing this runbook.
- `docs/bootstrap-checklist.md` – quickstart that now links here for compose/doc guidance.
- `AGENTS.md` – agent expectations and BMAD method requirements.
- `scripts/README.md` – status of supporting automation.
