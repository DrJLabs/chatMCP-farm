# Risk Profile: Story 2.1

Date: 2025-09-24
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 4
- Critical Risks: 0
- High Risks: 2
- Medium Risks: 2
- Risk Score: 72/100

Story 2.1 upgrades the MCP test server to Express 5 and refreshes the toolchain. The top risks involve regression in auth middleware due to the Express 5 router changes and insufficient coverage of new Vitest 3 configuration. Documentation lag and dependency hygiene also pose operational challenges if rollbacks are needed quickly.

## High Risks Requiring Immediate Attention

### 1. TECH-001: Express 5 async router changes break auth guard ordering

**Score:** 6 (High)

- **Probability:** Medium — Express 5 promotes async handlers and subtle signature changes; existing middleware order/tests may miss regressions until runtime.
- **Impact:** High — A broken auth guard would expose diagnostics endpoints without enforcement, undermining the workspace security baseline.
- **Mitigation:** Add Supertest integration coverage for `/mcp` and diagnostics endpoints under authenticated/unauthenticated paths post-upgrade; validate middleware order explicitly and capture in README.

### 2. TECH-002: Vitest 3 migration misses config flags and coverage plugins

**Score:** 6 (High)

- **Probability:** Medium — Vitest 3 adjusts default isolate behaviour and coverage plugin API; missing updates frequently break CI.
- **Impact:** High — Without a reliable test runner, we lose regression protection for Express 5 changes and compose smoke workflows.
- **Mitigation:** Pair config updates with a workspace aggregate test run, document CLI changes, and add a smoke script invocation to CI notes.

## Risk Distribution

### By Category

- Technical: 3 risks (2 high, 1 medium)
- Operational: 1 risk (0 high)
- Security/Performance/Data/Business: 0 risks

### By Component

- Backend service: 4 risks (package manifest, Express middleware, Vitest config, README/rollback docs)

## Detailed Risk Register

| Risk ID  | Category  | Description                                                                                                     | Probability | Impact | Score | Priority | Mitigation Highlights                                                                                                     |
|----------|-----------|-----------------------------------------------------------------------------------------------------------------|-------------|--------|-------|----------|---------------------------------------------------------------------------------------------------------------------------|
| TECH-001 | Technical | Express 5 async handlers and error signature changes could bypass or double-invoke auth middleware.            | Medium (2)  | High (3) | 6   | High     | Extend Supertest suites for auth/diagnostics, assert middleware order, document Express 5 guard expectations.             |
| TECH-002 | Technical | Vitest 3 config changes may disable coverage plugin or break global setup, reducing regression signal.         | Medium (2)  | High (3) | 6   | High     | Update `vitest.config.ts`, run workspace aggregate tests, document CLI changes, monitor first CI run for flake indicators.|
| OPS-001  | Operational | Rollback plan may fail if baseline lockfile hash/git tag not captured prior to reinstall.                     | Medium (2)  | Medium (2) | 4 | Medium   | Document rollback branch/tag, store hash in README, verify restore instructions by performing dry-run `npm ci`.          |
| TECH-003 | Technical | Removing `@types/express` may surface latent type gaps if custom typings rely on legacy namespace exports.      | Low (1)     | Medium (2) | 2 | Low      | Run TypeScript strict build, search for legacy namespace imports, add targeted shim if needed, and document findings.     |

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- Supertest integration verifying `/mcp` and diagnostics routes enforce auth and return expected responses after Express 5 migration.
- Vitest 3 smoke run with coverage enabled under Node 22 and Node 24 runners (locally or in CI).

### Priority 2: Supporting Medium Risk Tests
- Dry-run rollback using saved lockfile hash or git tag to confirm install reliability.
- Lint/build pipeline to catch lingering `@types/express` imports.

### Priority 3: Medium/Low Risk Tests
- `npm ls` checks for Express 4 remnants, backed by unit tests ensuring no reliance on removed namespaces.

## Risk Acceptance Criteria

- **Must Fix Before Production:** TECH-001, TECH-002.
- **Can Deploy with Mitigation:** OPS-001 (with documented rollback hash), TECH-003 (if strict build confirms coverage).
- **Accepted Risks:** None.

## Monitoring Requirements

- Track first CI runs and express error logs for unexpected auth bypass.
- Monitor Vitest duration and failure frequency for flakiness after the upgrade.
- Include rollback validation step in release checklist until documentation updates in Story 2.4 land.

## Risk Review Triggers

- Express 5.x patch updates requiring revalidation of middleware order.
- Additional services adopting the same test stack (elevates shared risk).
- Introduction of new diagnostics tooling that adds routes.

---

**Gate Summary Snippet**

```yaml
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 1
    low: 1
  highest:
    id: TECH-001
    score: 6
    title: Express 5 async router changes break auth guard ordering
  recommendations:
    must_fix:
      - Extend Supertest coverage to confirm Express 5 middleware order and auth guard behaviour
      - Update Vitest config and document CLI usage to avoid coverage regressions
    monitor:
      - Validate rollback instructions with recorded lockfile hash/tag
      - Watch TypeScript builds for residual @types/express namespace usage
```

**Trace Hook**

```
Risk profile: docs/qa/assessments/2.1-risk-20250924.md
```
