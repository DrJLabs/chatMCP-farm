# Test Design: Story 4.2

Date: 2025-09-25
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total Test Scenarios: 9
- Unit Tests: 2 (22%)
- Integration Tests: 5 (56%)
- E2E Tests: 2 (22%)
- Priority Mix: P0 â€“ 5, P1 â€“ 3, P2 â€“ 1, P3 â€“ 0

## Test Scenarios by Acceptance Criteria

### AC1 â€“ Compose profile definition aligns with bridge image and Traefik wiring

| ID            | Level       | Priority | Test                                                                                               | Justification |
|---------------|-------------|----------|----------------------------------------------------------------------------------------------------|---------------|
| 4.2-INT-001   | Integration | P0       | `scripts/compose.sh --profile filesystem-mcp config` renders service using `Bridge.Dockerfile`, `proxy` network, and Traefik labels routing `${MCP_PUBLIC_HOST}` to `${SSE_PORT}`. | Guarantees compose aggregation exports the opt-in profile with correct routing and network membership. |
| 4.2-UNIT-001  | Unit        | P1       | Static lint (`yq`/`npm` task) asserts `profiles: [filesystem-mcp]`, `build.context` path, and Traefik label keys in `services/filesystem-mcp/compose.yml`. | Prevents accidental removal of profile metadata or label keys before config rendering. |

### AC2 â€“ Host mounts default to read-only with guarded overrides

| ID            | Level       | Priority | Test                                                                                      | Justification |
|---------------|-------------|----------|-------------------------------------------------------------------------------------------|---------------|
| 4.2-INT-002   | Integration | P0       | `COMPOSE_PROFILES=filesystem-mcp scripts/compose.sh up` with defaults, then `docker inspect` verifies `/projects` `/VAULTS` mounts are `:ro` and env shows `ALLOW_WRITE=false`. | Confirms secure defaults and read-only enforcement, mitigating SEC-4.2-001. |
| 4.2-INT-003   | Integration | P0       | Override `HOST_VAULTS_ROOT=/nonexistent` and attempt start; expect failure with actionable message captured in logs. | Validates operator feedback when host paths missing (OPS-4.2-001). |
| 4.2-INT-006   | Integration | P1       | Start container with `ALLOW_WRITE=true ENABLE_ROOTS=true` in a sandbox; assert log banner warns about elevated risk and smoke script records approval note. | Ensures deliberate overrides produce auditable warnings, reducing SEC-4.2-001 residual risk. |

### AC3 â€“ Environment toggles and resource limits propagate from `.env`

| ID            | Level       | Priority | Test                                                                                 | Justification |
|---------------|-------------|----------|--------------------------------------------------------------------------------------|---------------|
| 4.2-INT-004   | Integration | P0       | `docker compose run --rm filesystem-mcp-bridge env` verifies `FS_ALLOWED`, `SSE_PORT`, `ALLOW_WRITE`, `ENABLE_ROOTS` match `.env` values and resource limits surface in inspect output. | Confirms container runtime sees the env expected by bridge entrypoint. |

### AC4 â€“ `.env.example` documents security toggles and host configuration

| ID            | Level       | Priority | Test                                                                                              | Justification |
|---------------|-------------|----------|---------------------------------------------------------------------------------------------------|---------------|
| 4.2-UNIT-002  | Unit        | P1       | Static check ensures `.env.example` includes Keycloak placeholders, host root variables, and comments keeping `ALLOW_WRITE=false` / `ENABLE_ROOTS=false`. | Protects against regression that ships permissive defaults in documentation. |

### AC5 â€“ Compose profile bring-up, logs, and smoke evidence captured

| ID            | Level       | Priority | Test                                                                                                | Justification |
|---------------|-------------|----------|-----------------------------------------------------------------------------------------------------|---------------|
| 4.2-E2E-001   | E2E         | P0       | `COMPOSE_PROFILES=filesystem-mcp scripts/compose.sh up --build` then `curl https://${MCP_PUBLIC_HOST}` validates Traefik route, SSE port log, and allowed roots output; record teardown command. | Ensures operators can activate the profile end-to-end with documented evidence, covering OPS-4.2-002. |
| 4.2-E2E-002   | E2E         | P1       | Run `scripts/filesystem-mcp-bridge-smoke.sh filesystem-mcp-bridge:local` against compose-built image after bring-up; attach results to Dev Notes. | Confirms smoke harness stays green with compose wiring and protects against integration drift. |
| 4.2-INT-005   | Integration | P2       | Invoke `scripts/compose.sh --profile filesystem-mcp config` in CI and assert profile listed in summary output to catch aggregation drift. | Provides ongoing regression signal for TECH-4.2-001 with minimal runtime cost. |

## Risk Coverage Mapping
- **SEC-4.2-001** mitigated by 4.2-INT-002, 4.2-INT-006, and 4.2-UNIT-002 (default guardrails, warning banner, documentation check).
- **OPS-4.2-001** mitigated by 4.2-INT-003 and 4.2-E2E-001 (missing mount handling, successful run evidence).
- **OPS-4.2-002** mitigated by 4.2-E2E-001 (Traefik verification) and 4.2-INT-001 (label rendering).
- **TECH-4.2-001** mitigated by 4.2-INT-001 and 4.2-INT-005 (profile visibility checks in config and CI).

## Recommended Execution Order
1. Execute P0 integration/unit checks (4.2-INT-001, 4.2-INT-002, 4.2-INT-003, 4.2-INT-004).
2. Bring profile up end-to-end (4.2-E2E-001) and capture routing evidence.
3. Run override warning scenario (4.2-INT-006) and smoke harness (4.2-E2E-002).
4. Finish with static documentation checks (4.2-UNIT-001, 4.2-UNIT-002) and CI regression guard (4.2-INT-005).

```text
Test design matrix stored at docs/qa/assessments/4.2-test-design-20250925.md
P0 Scenarios: 5
```

## Notes
- Prefer reusing existing reviewer lint jobs for the static checks to keep implementation lightweight.
- Capture compose outputs as artifacts for PO/QA evidence when running the P0 suite.

## ðŸ”¬ Research & Validation Log
- 2025-09-25: Confirmed Docker Compose profiles and the `COMPOSE_PROFILES` env flag gate optional services so AC1/AC5 scenarios align with published activation guidance. [Research: Docker Docs â€“ "Use service profiles" (accessed 2025-09-25)]
- 2025-09-25: Reviewed Docker bind-mount security recommendations showing `readonly`/`ro` enforce immutable host mounts, supporting AC2 default tests. [Research: Docker Docs â€“ "Bind mounts" (accessed 2025-09-25)]
- 2025-09-25: Rechecked environment variable precedence/interpolation rules to ensure AC3/AC4 tests validate `.env` propagation rather than CLI overrides. [Research: Docker Docs â€“ "Environment variables precedence" (accessed 2025-09-25)]
