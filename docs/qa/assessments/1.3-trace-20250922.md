# Requirements Traceability Matrix

## Story: 1.3 – Compose Integration & ChatGPT Runbook

Date: 2025-09-22  
Analyst: Quinn (QA)

### Coverage Summary
- Total Requirements: 5
- Fully Covered: 3 (60%)
- Partially Covered: 2 (40%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1 – Compose orchestration documents both CLI (`--profile`) and automation (`COMPOSE_PROFILES`) paths and keeps the service opt-in
- **Coverage:** Full
- **Evidence / Tests:**
  - Guardrail script: `scripts/check-compose-profile.sh` (invoked by `npm run guard` and `npm test`) copies `.env.example` if needed and executes `COMPOSE_PROFILES=mcp-test-server scripts/compose.sh --profile mcp-test-server config`, failing when the profile pulls additional services.
  - Manual checklist: `docs/runbooks/compose-and-docs.md` updates reviewed, confirming opt-in workflow and network prerequisites.

#### AC2 – Smoke workflow captures Accept headers and `Mcp-Session-Id`
- **Coverage:** Full
- **Evidence / Tests:**
  - `services/mcp-test-server/test/accept-header.spec.ts`
    - Given a POST `/mcp` request with Accept header set, When the initialize call succeeds, Then the response includes `Mcp-Session-Id` and `Mcp-Protocol-Version` headers. (unit/integration)
  - `scripts/healthcheck.sh`
    - Given valid `.keycloak-env` credentials, When the healthcheck runs, Then logs include Accept header used and session ID observed. (manual execution scripted)
  - `services/mcp-test-server/src/smoke.ts`
    - Given a smoke invocation with optional token, When the initialize request completes, Then console output records Accept header and session/protocol headers. (manual + script output)

#### AC3 – ChatGPT Developer Mode connection steps highlight DCR, `search`/`fetch`, and risk posture
- **Coverage:** Partial
- **Evidence / Tests:**
  - Documentation review: `docs/oauth-keycloak.md` validation playbook updated with Developer Mode checklist, trusted-host reminder, and manifest tool requirement. (manual)
  - Recommended E2E scenario (pending): Follow updated runbook to connect Developer Mode in staging and confirm DCR scope mapping.
- **Note:** Execute staged Developer Mode connector smoke to elevate coverage to FULL.

#### AC4 – README / `.env.example` align with automation and safety guidance
- **Coverage:** Partial
- **Evidence / Tests:**
  - Documentation review: `services/mcp-test-server/README.md` and `.env.example` refreshed with secret handling and profile teardown reminders. (manual)
  - Manual sanity check ensures `.keycloak-env` sourcing instructions prevent secret leakage.
- **Note:** Automate doc lint/check or add integration test verifying `.env` keys feed compose script as documented.

#### AC5 – Workspace lint/build/test scripts remain green with header coverage
- **Coverage:** Full
- **Evidence / Tests:**
  - Unit: `services/mcp-test-server/test/accept-header.spec.ts` (header assertions).
  - Unit: `services/mcp-test-server/test/diagnostics.spec.ts` (diagnostics payload coverage).
  - Integration: `npm run build --workspace mcp-test-server` (tsconfig.build.json) and `npm run test --workspace mcp-test-server` executed successfully. 
  - Manual: `npm run lint` aggregate confirms workspace lint pipeline remains clean.

### Coverage Gaps
1. **AC3** – Developer Mode connector workflow relies on manual runbook validation. Severity: Medium.  
   *Recommendation:* Schedule periodic staging connector verification following the documented checklist; capture evidence in QA artifacts.
2. **AC4** – README/`.env` guidance validated manually only. Severity: Low.  
   *Recommendation:* Introduce documentation lint or automated diff checks to detect missing teardown reminders.

### Trace Gate Snippet
```yaml
trace:
  totals:
    requirements: 5
    full: 3
    partial: 2
    none: 0
  planning_ref: docs/qa/assessments/1.3-test-design-20250922.md
  uncovered: []
  notes: docs/qa/assessments/1.3-trace-20250922.md
```

**Hook:** `Trace matrix: docs/qa/assessments/1.3-trace-20250922.md`
