# Test Design: Story 2.1

Date: 2025-09-24
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 7
- Unit tests: 2 (29%)
- Integration tests: 4 (57%)
- E2E tests: 1 (14%)
- Priority distribution: P0: 3, P1: 3, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: Pin Express 5 / SDK toolchain and remove Express 4 artifacts

#### Scenarios

| ID             | Level       | Priority | Test Description                                                                 | Justification                                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 2.1-UNIT-001   | Unit        | P1       | Snapshot `package.json` dependency versions via Jest/Vitest module import checks | Verifies manifest changes without npm invocation; fast feedback on version drift.                                  |
| 2.1-INT-001    | Integration | P0       | Run `npm ls express` + `npm ls @types/express` during CI to fail if legacy deps remain | Ensures deduped tree contains only Express 5; prevents runtime duplication issues (mitigates TECH-001, TECH-003). |

### AC2: Express 5 middleware + error handlers compile and behave as expected

#### Scenarios

| ID             | Level       | Priority | Test Description                                                                 | Justification                                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 2.1-UNIT-002   | Unit        | P0       | Validate custom error handler exports `(err, req, res, next)` typing matches Express 5 | Fast verification that shared error util conforms to new signature; fails before runtime regressions.             |
| 2.1-INT-002    | Integration | P0       | Supertest auth enforcement regression: `/mcp` + diagnostics under auth/unauth cases | Directly validates middleware ordering and async handling after Express 5 migration (addresses TECH-001).         |

### AC3: Vitest 3 migration + workspace scripts succeed

#### Scenarios

| ID             | Level       | Priority | Test Description                                                                 | Justification                                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 2.1-INT-003    | Integration | P0       | Execute `npm run lint|test|build --workspace mcp-test-server` and `npm run smoke` | Confirms upgraded test runner and smoke scripts operate on Node 22/24 (mitigates TECH-002).                        |
| 2.1-INT-004    | Integration | P1       | Run workspace aggregate test command (if added) to ensure cross-workspace compatibility | Detects regression from shared tooling upgrade; ensures new script works before documentation updates publish.     |

### AC4: Documentation & rollback guidance updated

#### Scenarios

| ID             | Level       | Priority | Test Description                                                                 | Justification                                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 2.1-E2E-001    | E2E         | P2       | Manual doc verification: Follow README rollback instructions to restore pre-upgrade snapshot | Validates operator-facing guidance and ensures rollback steps function (covers OPS-001).                            |

## Risk Coverage

- TECH-001 mitigated by scenarios 2.1-INT-002 and 2.1-INT-003.
- TECH-002 mitigated by scenarios 2.1-INT-003 and 2.1-INT-004.
- OPS-001 mitigated by scenario 2.1-E2E-001.
- TECH-003 mitigated by scenarios 2.1-UNIT-002 and 2.1-INT-001.

## Recommended Execution Order

1. Run unit scenarios (2.1-UNIT-001, 2.1-UNIT-002) for immediate feedback.
2. Execute integration scenarios (2.1-INT-001 â†’ 2.1-INT-004) prioritizing P0 coverage.
3. Perform manual E2E documentation validation (2.1-E2E-001) once automation passes.

---

**Gate Summary Snippet**

```yaml
test_design:
  scenarios_total: 7
  by_level:
    unit: 2
    integration: 4
    e2e: 1
  by_priority:
    p0: 3
    p1: 3
    p2: 1
  coverage_gaps: []
```

**Trace Hook**

```
Test design matrix: docs/qa/assessments/2.1-test-design-20250924.md
P0 tests identified: 3
```

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (favoured unit/integration for fast feedback)
- [x] No duplicate coverage across levels beyond risk-driven defense in depth
- [x] Priorities align with risk profile
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent

