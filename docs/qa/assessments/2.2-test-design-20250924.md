# Test Design: Story 2.2

Date: 2025-09-24
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 9
- Unit tests: 2 (22%)
- Integration tests: 5 (56%)
- E2E tests: 2 (22%)
- Priority distribution: P0: 4, P1: 4, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1: Pin Express 5 / SDK toolchain and remove Express 4 artifacts

#### Scenarios

| ID             | Level       | Priority | Test Description                                                                 | Justification                                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 2.2-UNIT-001   | Unit        | P1       | Snapshot `package.json` dependency versions for GitHub MCP via import-based assertions | Fast detection of version drift without reinstall; mirrors Story 2.1 safeguard.                                   |
| 2.2-INT-001    | Integration | P0       | Run `npm ls express` and `npm ls @types/express` in CI for the GitHub workspace   | Confirms Express 5 tree and surfaces lingering Express 4 artifacts (mitigates TECH-201, SEC-201).                 |

### AC2: Express 5 middleware, async handlers, and error flow compile/behave correctly

#### Scenarios

| ID             | Level       | Priority | Test Description                                                                 | Justification                                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 2.2-UNIT-002   | Unit        | P0       | Assert custom error/middleware exports follow Express 5 `(err, req, res, next)` signature | Guards against regressions after removing `express-async-errors`; fails fast during build (mitigates TECH-201).    |
| 2.2-INT-002    | Integration | P0       | Supertest auth regression covering `/mcp` + diagnostics under auth/unauth cases | Validates middleware order and async behaviour across routers (mitigates TECH-201).                                |

### AC3: Vitest 3 + Supertest 7 migration succeeds with scripts

#### Scenarios

| ID             | Level       | Priority | Test Description                                                                 | Justification                                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 2.2-INT-003    | Integration | P0       | Execute `npm run lint|test|build --workspace github-mcp` plus `npm run smoke` on Node 22/24 | Confirms Vitest 3.2 + Supertest 7.1.x operate across supported runtimes (mitigates TECH-202).                     |
| 2.2-INT-004    | Integration | P1       | Run workspace aggregate test command (e.g., `npm run test --workspaces`) to ensure parity | Detects regressions introduced by the shared tooling upgrade (supports TECH-202, SEC-201).                         |
| 2.2-INT-005    | Integration | P1       | Simulate GitHub REST API rate-limit responses (`403/429`) and assert headers propagate through service | Ensures clients see actionable retry guidance when GitHub throttles requests (mitigates SEC-201, OPS-201).         |

### AC4: Documentation and rollback guidance updated

#### Scenarios

| ID             | Level       | Priority | Test Description                                                                 | Justification                                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 2.2-E2E-001    | E2E         | P1       | Manual verification of README/rollback steps: capture pre-upgrade commit hash, perform dry-run restore | Ensures operators can revert quickly if GitHub MCP upgrade fails (mitigates OPS-201).                               |

### AC5: Follow-up items logged for unresolved dependencies

#### Scenarios

| ID             | Level       | Priority | Test Description                                                                 | Justification                                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| 2.2-E2E-002    | E2E         | P2       | Confirm follow-up entry recorded in `docs/stories/follow-ups.md` for `mcp-auth-kit` peer update | Keeps SEC-201 visible until Story 2.4 resolves it; provides audit trail for operators.                             |

## Risk Coverage

- TECH-201 mitigated by scenarios 2.2-UNIT-002 and 2.2-INT-002.
- TECH-202 mitigated by scenarios 2.2-INT-003 and 2.2-INT-004.
- SEC-201 mitigated by scenarios 2.2-INT-001, 2.2-INT-004, and 2.2-INT-005, plus documentation validation 2.2-E2E-002.
- OPS-201 mitigated by scenarios 2.2-INT-005 (operational headers) and 2.2-E2E-001.

## Recommended Execution Order

1. Execute unit scenarios (2.2-UNIT-001, 2.2-UNIT-002) to fail fast on signature or version drift.
2. Run integration suites (2.2-INT-001 ‚Üí 2.2-INT-004) prioritising P0 coverage across tooling and middleware.
3. Complete E2E verifications (2.2-E2E-001, 2.2-E2E-002) to confirm operator guidance and follow-up traceability.

---

**Gate Summary Snippet**

```yaml
test_design:
  scenarios_total: 9
  by_level:
    unit: 2
    integration: 5
    e2e: 2
  by_priority:
    p0: 4
    p1: 4
    p2: 1
  coverage_gaps: []
```

**Trace Hook**

```
Test design matrix: docs/qa/assessments/2.2-test-design-20250924.md
P0 tests identified: 4
```

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels follow the unit ‚Üí integration ‚Üí e2e guidance
- [x] No redundant overlap beyond risk-driven defense in depth
- [x] Priorities align with risk profile weighting
- [x] Test IDs follow naming convention and remain atomic
- [x] Scenarios are independent and reference mitigation targets

## üî¨ Research & Validation Log
- 2025-09-24: Express 5 release notes emphasize built-in promise handling, reinforcing removal of third-party async wrappers and deeper middleware regression coverage. Source: Express Blog ‚Äì "Introducing Express v5" (published 2024-10-15). ÓàÄciteÓàÇturn2search1ÓàÅ
- 2025-09-24: Vitest 3.2 announcement documents deprecation of `workspace` configs in favour of `projects`, informing lint/test script updates in scenarios 2.2-INT-003/004. Source: Vitest Blog ‚Äì "Vitest 3.2 is out!" (published 2025-06-02). ÓàÄciteÓàÇturn0search0ÓàÅ
- 2025-09-24: Supertest 7.1.x release timeline confirms superagent 10.x dependency shift that integration scenarios must validate. Source: SourceForge SuperTest mirror release listings (accessed 2025-09-24). ÓàÄciteÓàÇturn1search6ÓàÅ
- 2025-09-24: GitHub REST API documentation highlights 403/429 throttling semantics and required headers, prompting rate-limit propagation scenario 2.2-INT-005. Source: GitHub Docs ‚Äì "Rate limits for the REST API" (accessed 2025-09-24). ÓàÄciteÓàÇturn3search0ÓàÅ
