# Test Design: Story 1.1

Date: 2025-09-21
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 7
- Unit tests: 2 (29%)
- Integration tests: 3 (43%)
- E2E tests: 2 (29%)
- Priority distribution: P0: 2, P1: 3, P2: 2

The scaffold touches security-critical OAuth handling and infrastructure wiring, so early-unit validation and integration smoke tests run before the heavier compose-based E2E checks.

## Test Scenarios by Acceptance Criteria

### AC1: Service scaffold exists under `services/mcp-test-server`

| ID              | Level       | Priority | Test                                                             | Justification |
|-----------------|-------------|----------|------------------------------------------------------------------|---------------|
| 1.1-INT-001     | Integration | P0       | Start server via supertest harness and verify manifest/tool load | Confirms Express+MCP wiring boots end-to-end |
| 1.1-E2E-001     | E2E         | P1       | `docker compose` up with new service enabled; confirm health and manifest | Validates scaffold behaves within full stack |

### AC2: Environment configuration documents OAuth variables

| ID              | Level | Priority | Test                                                                 | Justification |
|-----------------|-------|----------|----------------------------------------------------------------------|---------------|
| 1.1-UNIT-001    | Unit  | P0       | Env schema test validates required OAuth URLs and origin defaults; ensures docs and runtime align | Guards secret handling logic without infrastructure |
| 1.1-E2E-002     | E2E   | P2       | Documentation walkthrough: follow README to configure `.env`/Keycloak from scratch | Confirms onboarding guidance completeness |

### AC3: Docker Compose fragment matches aggregation conventions

| ID              | Level       | Priority | Test                                                                      | Justification |
|-----------------|-------------|----------|---------------------------------------------------------------------------|---------------|
| 1.1-INT-002     | Integration | P1       | Run `docker compose config` with/without snippet to confirm opt-in behavior and resource limits | Detects collisions before runtime |

### AC4: Basic TypeScript entrypoint boots Express + MCP

| ID              | Level       | Priority | Test                                                                      | Justification |
|-----------------|-------------|----------|---------------------------------------------------------------------------|---------------|
| 1.1-UNIT-002    | Unit        | P2       | Validate placeholder MCP tool returns expected static payload structure   | Fast feedback on business logic |
| 1.1-INT-001     | Integration | P0       | (Shared with AC1)                                                         | End-to-end boot validation |

### AC5: Local npm scripts build and lint

| ID              | Level       | Priority | Test                                                       | Justification |
|-----------------|-------------|----------|------------------------------------------------------------|---------------|
| 1.1-INT-003     | Integration | P1       | Execute `npm run lint --workspaces --if-present` and ensure service passes | Validates workspace wiring and TypeScript config |

### AC6: Streamable HTTP binds to all interfaces with origin allow-list

| ID              | Level       | Priority | Test                                                                          | Justification |
|-----------------|-------------|----------|-------------------------------------------------------------------------------|---------------|
| 1.1-INT-001     | Integration | P0       | With `MCP_ALLOWED_ORIGINS="https://good.example"`, assert `Origin: https://good.example` returns 200 and `Origin: https://evil.test` returns 403 | Security regression check |
| 1.1-UNIT-001    | Unit        | P0       | Env schema ensures `MCP_ALLOWED_ORIGINS` is a comma-separated list (trimmed) and defaults to no origins when unset | Prevents insecure defaults |

## Risk Coverage

| Risk ID | Mitigated By                                   |
|---------|------------------------------------------------|
| SEC-001 | 1.1-UNIT-001, 1.1-E2E-002                      |
| TECH-001| 1.1-INT-002, 1.1-E2E-001                       |
| OPS-001 | 1.1-E2E-002                                    |
| SEC-002 | 1.1-UNIT-001, 1.1-INT-001                      |

## Recommended Execution Order

1. Run P0 unit tests (1.1-UNIT-001) to validate env and origin settings.
2. Run P0 integration test (1.1-INT-001) to verify secure startup behavior.
3. Execute remaining P1 integration tests (1.1-INT-002, 1.1-INT-003).
4. Bring up compose stack for E2E validation (1.1-E2E-001) and documentation walkthrough (1.1-E2E-002).
5. Finish with remaining P2 unit scenario (1.1-UNIT-002) if not already executed.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 7
  by_level:
    unit: 2
    integration: 3
    e2e: 2
  by_priority:
    p0: 2
    p1: 3
    p2: 2
  coverage_gaps: []
```

## Trace References

Test design matrix: docs/qa/assessments/1.1-test-design-20250921.md
P0 tests identified: 2

## ðŸ”¬ Research & Validation Log
- 2025-09-21: Reviewed GitGuardian State of Secrets Sprawl 2025 to confirm secret-scanning (gitleaks/ggshield) remains best practice for new services handling OAuth credentials.
- 2025-09-21: Consulted Docker Compose 2.26 release notes on resource constraints to ensure integration tests assert CPU/memory limits and optional profiles.
- 2025-09-21: Cross-checked MCP Streamable HTTP transport updates (2025-06-18) to validate Origin enforcement scenarios remain required even for local scaffolds.
- Open question: determine preferred CI runner for compose smoke tests (local vs. containerized) before wiring automation.
