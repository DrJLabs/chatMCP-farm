# Risk Profile: Story 2.2

Date: 2025-09-24
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 4
- Critical Risks: 0
- High Risks: 3
- Medium Risks: 1
- Risk Score: 65/100

Story 2.2 upgrades the GitHub MCP service to Express 5, the latest MCP SDK, Vitest 3.2, and associated tooling. The primary risks are centred on async middleware parity, the Supertest/vitest toolchain jump, and the unresolved Express 5 peer requirement in `mcp-auth-kit`. Operationally, the upgrade still depends on precise rollback hygiene while Story 2.4 lands the shared library changes; short-term workspace warnings are acceptable if documented and linked to follow-up closure.

## High Risks Requiring Immediate Attention

### 1. TECH-201: Express 5 async router changes break GitHub route chaining

**Score:** 6 (High)

- **Probability:** Medium — The service wires GitHub-specific routers, auth middleware, and diagnostics endpoints; Express 5’s promise semantics can bypass error handlers if chaining is incomplete.
- **Impact:** High — A misordered middleware chain can expose routes without auth enforcement or fail webhook simulators, undermining parity with the test server baseline.
- **Mitigation:** Extend Supertest coverage for authenticated/unauthenticated permutations on `/mcp` and diagnostics, explicitly assert middleware order, and follow Express 5 async handler guidance when removing legacy helpers.

### 2. TECH-202: Supertest 7.1.x + Vitest 3.2 integration breaks GitHub API mocks

**Score:** 6 (High)

- **Probability:** Medium — Supertest now depends on superagent 10.x and Vitest 3.2 adjusts module isolation; the GitHub service stubs multiple HTTP exchanges that can regress silently.
- **Impact:** High — Broken mocks eliminate regression signal for GitHub tool flows and may mask streaming regressions until production testing.
- **Mitigation:** Run `npm run test --workspace github-mcp` and smoke scripts under Node 22/24, verify mock adapters against superagent 10.x, and capture evidence in the Dev Agent Record.

### 3. SEC-201: `mcp-auth-kit` peer range still pinned to Express 4

**Score:** 6 (High)

- **Probability:** Medium — Until Story 2.4 relaxes peers, installing GitHub MCP against `mcp-auth-kit` may emit warnings or fail strict installations.
- **Impact:** High — A failed install or runtime incompatibility blocks service deployment and reintroduces Express 4 code paths, defeating the upgrade.
- **Mitigation:** Document the warning in README, coordinate the peer update in Story 2.4, and add CI guard (`npm ls express`) to alert on reintroduced Express 4 transitive deps.

## Risk Distribution

### By Category

- Technical: 3 risks (3 high)
- Security: 1 risk (1 high)
- Operational: 1 risk (1 medium)

### By Component

- GitHub MCP service: Express middleware, Vitest config, Supertest suite, README/rollback guidance
- Shared package: `mcp-auth-kit` peer dependency alignment

## Detailed Risk Register

| Risk ID  | Category   | Description                                                                                                    | Probability | Impact | Score | Priority | Mitigation Highlights                                                                                                      |
|----------|------------|----------------------------------------------------------------------------------------------------------------|-------------|--------|-------|----------|----------------------------------------------------------------------------------------------------------------------------|
| TECH-201 | Technical  | Express 5 async routing may reorder/bypass GitHub middleware, leading to unauthenticated diagnostics or failed tooling flows. | Medium (2)  | High (3) | 6 | High | Add Supertest auth enforcement tests, audit middleware order, remove obsolete `express-async-errors` wrappers, document changes. |
| TECH-202 | Technical  | Supertest 7.1.x and Vitest 3.2 upgrades can invalidate existing mocks or coverage configuration.              | Medium (2)  | High (3) | 6 | High | Run full lint/test/build/smoke scripts on Node 22/24, update Vitest config for `projects`, validate coverage remapping, capture results. |
| SEC-201  | Security   | `mcp-auth-kit` Express 4 peer dependency conflicts with upgraded service, causing install/runtime warnings or failure. | Medium (2)  | High (3) | 6 | High | Coordinate with Story 2.4 to release updated peers, document temporary warning acceptance in README, and add CI check for Express 4 remnants.|
| OPS-201  | Operational| Rollback plan fails if pre-upgrade lockfile hash/tag isn’t captured before regeneration.                        | Medium (2)  | Medium (2) | 4 | Medium | Record git hash/branch in README, verify rollback via dry-run `npm ci`, and log evidence in Dev Agent Record.                            |

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- Supertest integration suites covering authenticated/unauthenticated access and error propagation after Express 5 migration.
- Vitest 3.2 regression run (lint/test/build) plus smoke script invocation under Node 22/24 to validate new tooling.
- `npm ls express`/`npm ls @types/express` guard in CI to surface peer dependency regressions.

### Priority 2: Supporting Medium Risk Tests
- Dry-run rollback using recorded lockfile hash/git tag to confirm operator documentation.
- TypeScript strict build focused on removal of legacy async helpers and namespace imports.

### Priority 3: Medium/Low Risk Tests
- Docs lint/check or manual walkthrough ensuring README/compose instructions reference Express 5 baseline.

## Risk Acceptance Criteria

- **Must Fix Before Production:** TECH-201, TECH-202, SEC-201.
- **Can Deploy with Mitigation:** OPS-201 (with documented rollback evidence).
- **Accepted Risks:** None at this time.

## Monitoring Requirements

- Watch initial CI runs for new Vitest/Supertest flakiness and warnings about `mcp-auth-kit` peer ranges.
- Monitor service logs for Express 5 async error handling anomalies.
- Include rollback verification in release checklist until Story 2.4 lands.

## Risk Review Triggers

- Completion of Story 2.4 (`mcp-auth-kit` peer update) — reassess SEC-201.
- Express 5.x patch releases modifying async behaviour.
- Additional services adopting the upgraded tooling (shared risk surface increases).

---

**Gate Summary Snippet**

```yaml
risk_summary:
  totals:
    critical: 0
    high: 3
    medium: 1
    low: 0
  highest:
    id: TECH-201
    score: 6
    title: Express 5 async router changes break GitHub route chaining
  recommendations:
    must_fix:
      - Extend Supertest coverage and audit middleware order for the GitHub MCP service post-upgrade
      - Run Vitest 3.2 + Supertest 7.1.x suites under Node 22/24 and document results
      - Coordinate Express 5 peer update in `mcp-auth-kit` to eliminate install warnings/failures
    monitor:
      - Verify rollback instructions via dry-run `npm ci` using recorded lockfile hash/tag
```

**Trace Hook**

```
Risk profile: docs/qa/assessments/2.2-risk-20250924.md
```
