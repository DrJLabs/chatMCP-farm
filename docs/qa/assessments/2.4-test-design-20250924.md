# Test Design: Story 2.4 â€“ Upgrade Auth Kit Peer Dependencies and Documentation

Date: 2025-09-24  
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 9
- By level: Unit 2, Integration 6, End-to-End 1
- Priority distribution: P0 = 6, P1 = 2, P2 = 1
- Key focus: dependency alignment validation, JWT verification safety, deterministic post-bump workflow, documentation currency.

## Test Scenarios by Acceptance Criteria

### AC1 â€“ Auth Kit peers updated to Express 5 + `jose@^6.1.0` with clean dependency tree

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.4-UNIT-001 | Unit | P0 | Add targeted unit tests around `createAuthKit`/`verifyBearerToken` to exercise Express 5 handler signatures and ensure JWT verification rejects invalid tokens with `jose@^6.1.0` | Pure logic within auth kit, fast feedback; guards against SEC-001 | SEC-001 |
| 2.4-INT-001 | Integration | P0 | Run `npm run build --workspace packages/mcp-auth-kit` after peer updates | Validates TypeScript build with new peers and removal of Express 4 types | TECH-001 |
| 2.4-INT-002 | Integration | P0 | Execute `npm ls express --workspaces` and `npm ls @types/express --workspaces`; fail if multiple Express trees or legacy types remain | Detects lingering Express 4 dependencies across workspace | TECH-001 |

### AC2 â€“ Workspace post-bump helper script in place and documented

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.4-INT-003 | Integration | P0 | Run `npm run postbump:test` on Node 22, asserting all workspace tests execute and exit zero | Ensures helper script wiring works in primary LTS runtime | OPS-001 |
| 2.4-INT-004 | Integration | P0 | Run `npm run postbump:test` on Node 20.19+ (with `node --run`) to confirm compatibility with CommonJS `require(esm)` expectations | Validates helper resilience on newer runtimes used for PQC-ready stacks | OPS-001 |

### AC3 â€“ Architecture shards updated to Express 5 baseline & rollback guidance

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.4-PRO-001 | E2E | P1 | Documentation review checklist: confirm `docs/architecture/tech-stack.md`, `coding-standards.md`, and operational playbook include Express 5 + `jose` v6 guidance and rollback notes | Ensures cross-team artifacts align with new baseline | OPS-001 |

### AC4 â€“ Auth kit README migration notes and changelog entry

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.4-INT-005 | Integration | P1 | Markdown linter / doc diff verifying README includes migration notes (peer range, helper usage, Node runtime expectations) | Prevents operational drift and documents security implications | SEC-001, OPS-001 |

### Cross-Cutting Quality

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 2.4-UNIT-002 | Unit | P2 | Lint rule or TypeScript ambient test ensuring error handler signature matches Express 5 expectations and masks sensitive error payloads | Guards against DATA-001 through compile-time enforcement | DATA-001 |
| 2.4-INT-006 | Integration | P0 | Validate workspace/root `package.json` engines guard (`>=20.19.0`) and fail-fast messaging when running `npm run postbump:test` under Node 18.x | Ensures unsupported Node runtimes are blocked in line with jose v6 breaking changes | SEC-001, OPS-001 |

## Risk Coverage Summary
- TECH-001 mitigated by 2.4-INT-001/002
- SEC-001 mitigated by 2.4-UNIT-001, 2.4-INT-005, and 2.4-INT-006
- OPS-001 mitigated by 2.4-INT-003/004, 2.4-INT-005, and 2.4-INT-006
- DATA-001 mitigated by 2.4-UNIT-002
- PERF-001 monitored via helper runtime metrics (no dedicated test; track via CI duration reports)

## Recommended Execution Order
1. Unit: 2.4-UNIT-001, 2.4-UNIT-002 (fast feedback on JWT and error handling).
2. Integration: 2.4-INT-001, 2.4-INT-002 (dependency sanity) before publishing the auth kit.
3. Integration: 2.4-INT-003, 2.4-INT-004 to validate post-bump helper across runtimes.
4. Integration/E2E docs: 2.4-INT-005, 2.4-PRO-001 to guarantee documentation alignment.
5. Monitor helper runtime (Perf risk) during CI dry-runs; capture duration in Dev Notes.

## Gate YAML Block
```yaml
test_design:
  scenarios_total: 9
  by_level:
    unit: 2
    integration: 6
    e2e: 1
  by_priority:
    p0: 6
    p1: 2
    p2: 1
  coverage_gaps:
    - perf helper runtime monitored via CI metrics (no automated test)
```

## Trace References
Test design matrix: qa.qaLocation/assessments/2.4-test-design-20250924.md  
P0 tests identified: 6

## ðŸ”¬ Research & Validation Log
- 2025-09-24: Reviewed Express v5 release announcement emphasizing router-level Promise support for async middleware and error propagation, informing the need for explicit tests around error handler signatures and documentation alignment.
- 2025-09-24: Parsed jose v6.0.0 breaking changes (dropping Node 18 and requiring `require(esm)`-capable runtimes, removing legacy algorithms) to justify Node engine enforcement and negative runtime checks.
- 2025-09-24: Consulted npm workspace run-script guidance on `--workspaces --if-present` usage to verify the post-bump helperâ€™s coverage expectations.
