# Requirements Traceability Matrix

## Story: 4.1 - Filesystem MCP Bridge Container

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 5 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: services/filesystem-mcp/Bridge.Dockerfile implements multi-stage build with pinned commit checkout and release binary copy.

**Coverage: FULL**

Given-When-Then Mappings:

- **Integration Script**: `docker build -f services/filesystem-mcp/Bridge.Dockerfile .`
  - Given: Builder executes from repo root with network access for the pinned commit
  - When: The multi-stage Docker build runs using the default `FILESYSTEM_MCP_REF`
  - Then: Cargo produces a release binary and the runtime stage contains the stripped artifact only
  - Coverage: full

- **Regression Step**: `scripts/filesystem-mcp-bridge-smoke.sh filesystem-mcp-bridge:local`
  - Given: The freshly built runtime image
  - When: The smoke script inspects the proxy version and entrypoint behaviour
  - Then: The build artefact responds as expected, proving the pinned binary is present
  - Coverage: full

#### AC2: Runtime stage installs python3-pip, pins mcp-proxy==0.9.0, labels OCI metadata, and keeps image lean.

**Coverage: FULL**

Given-When-Then Mappings:

- **Smoke Script**: `scripts/filesystem-mcp-bridge-smoke.sh`
  - Given: Runtime image built from the Dockerfile
  - When: `docker run --entrypoint mcp-proxy <image> --version` executes
  - Then: Output includes `mcp-proxy 0.9.0`, asserting the pinned proxy version
  - Coverage: unit

- **Image Inspection**: `docker image inspect filesystem-mcp-bridge:local`
  - Given: Built image
  - When: OCI labels are queried
  - Then: `org.opencontainers.image.version` reflects `mcp-proxy-0.9.0`
  - Coverage: integration

#### AC3: Entrypoint enforces FS_ALLOWED parsing, rejects empty/root paths, maps write/root toggles, launches SSE proxy on SSE_PORT.

**Coverage: FULL**

Given-When-Then Mappings:

- **Smoke Script**: `scripts/filesystem-mcp-bridge-smoke.sh`
  - Given: Image with entrypoint script
  - When: Container is started with `FS_ALLOWED=""`
  - Then: Process exits non-zero and logs the guardrail message, covering rejection behaviour
  - Coverage: integration

- **Manual Run (Dev Notes)**: `docker run --rm -e FS_ALLOWED=/tmp -e SSE_PORT=12010 filesystem-mcp-bridge:local`
  - Given: Runtime defaults
  - When: Container starts with valid root
  - Then: Logs show port binding to 12010 and selected roots, proving positive path
  - Coverage: full

#### AC4: Final image exposes port 12010, declares entrypoint, documents environment variables.

**Coverage: FULL**

Given-When-Then Mappings:

- **Smoke Script Port Probe**: `scripts/filesystem-mcp-bridge-smoke.sh`
  - Given: Container launched in the background by the smoke script
  - When: A Python socket probe inside the container attempts to connect to `127.0.0.1:12010`
  - Then: Connection succeeds within 10 seconds, demonstrating the port is listening with the declared entrypoint
  - Coverage: integration

- **Dockerfile Static Analysis**: `hadolint services/filesystem-mcp/Bridge.Dockerfile`
  - Given: Dockerfile contents
  - When: Lint/inspection runs
  - Then: Confirms `EXPOSE 12010` and `ENTRYPOINT` declarations are present
  - Coverage: unit

#### AC5: Dev notes include build validation steps and sample docker run commands demonstrating entrypoint wiring.

**Coverage: FULL**

Given-When-Then Mappings:

- **Smoke Script Doc Guard**: `scripts/filesystem-mcp-bridge-smoke.sh`
  - Given: Story dev notes file `docs/stories/4.1.filesystem-mcp-bridge-container.md`
  - When: Script greps for documented `docker build` and smoke script commands
  - Then: Check fails if documentation drifts from validated commands, keeping Dev Notes aligned
  - Coverage: unit

### Critical Gaps

- None — all acceptance criteria now have automated coverage.

### Test Design Recommendations

1. Add optional curl of `/healthz` once upstream bridge exposes an HTTP responder to validate protocol semantics end-to-end.
2. Integrate the smoke script into CI to prevent regressions before release.
3. Add unit shell tests (e.g., bats) for the entrypoint script to cover write/root toggle combinations.
4. Monitor documentation guardrails for additional commands that may require validation.

### Risk Assessment

- **High Risk**: None
- **Medium Risk**: None
- **Low Risk**: AC1–AC5 (guarded by reproducible build, smoke script automation, and documentation validation)
