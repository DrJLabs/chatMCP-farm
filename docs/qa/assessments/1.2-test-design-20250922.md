# Test Design: Story 1.2

Date: 2025-09-22
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 8
- Unit tests: 2 (25.0%)
- Integration tests: 5 (62.5%)
- E2E tests: 1 (12.5%)
- Priority distribution: P0: 4, P1: 4, P2: 0, P3: 0

This story is transport- and auth-centric. Fast unit coverage guards the manifest builder and diagnostics formatter, while integration smoke checks ensure env-driven configuration matches actual HTTP responses. A single manual E2E connector check remains valuable when access to ChatGPT Developer Mode is available.

### Tooling Notes

- Use Vitest as the lightweight test runner for both unit and integration coverage; it plays well with TypeScript ESM projects and keeps execution time low for solo maintainers.
- Pair Vitest with Supertest to exercise the Express handlers over HTTP boundaries without booting the listener directly, matching recent Node.js testing guidance.

## Test Scenarios by Acceptance Criteria

### AC1: Manifest exposes env-driven metadata

| ID             | Level       | Priority | Test                                                                 | Justification                                                                                                    |
|----------------|-------------|----------|----------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------|
| 1.2-UNIT-001   | Unit        | P0       | Validate manifest builder maps env values into manifest schema       | Pure config logic; fails fast if env names drift. Mitigates TECH-001.                                           |
| 1.2-INT-001    | Integration | P0       | GET `/.well-known/mcp/manifest.json` matches env + lists search/fetch | Ensures live endpoint matches config and keeps us aligned with ChatGPT tool guidance. Mitigates BUS-001 & TECH-001.       |

### AC2: PRM and root endpoints advertise resource + challenge headers

| ID             | Level       | Priority | Test                                                                      | Justification                                                                                     |
|----------------|-------------|----------|---------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| 1.2-INT-002    | Integration | P1       | GET `/.well-known/oauth-protected-resource` and `/` emit resource + `WWW-Authenticate` when auth on | Exercises middleware + origin filter behaviour without full MCP handshake. Mitigates TECH-001. |

### AC3: Unauthorized MCP calls stay deterministic

| ID             | Level       | Priority | Test                                                              | Justification                                                                                 |
|----------------|-------------|----------|-------------------------------------------------------------------|-----------------------------------------------------------------------------------------------|
| 1.2-INT-003    | Integration | P0       | POST `/mcp` without token returns 401 with challenge + Accept enforcement | Protects OAuth handshake and ensures clients see predictable errors. Mitigates SEC-001. |

### AC4: Diagnostics echo sanitized claim summary

| ID             | Level       | Priority | Test                                                                   | Justification                                                                                     |
|----------------|-------------|----------|------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------|
| 1.2-UNIT-002   | Unit        | P0       | Diagnostics presenter returns subset (sub, aud[], exp) without raw token | Security-focused pure function keeps implementation lightweight. Mitigates SEC-001.              |

### AC5: Documentation reflects new workflow

| ID             | Level       | Priority | Test                                                                 | Justification                                                                                      |
|----------------|-------------|----------|----------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
| 1.2-INT-004    | Integration | P1       | Scripted curl smoke (manifest, PRM, diagnostics) referenced in README succeeds | Confirms documented operator workflow works as written. Mitigates OPS-001 & TECH-001.            |

### AC6: Regression guardrails remain green

| ID             | Level       | Priority | Test                                                         | Justification                                                                               |
|----------------|-------------|----------|--------------------------------------------------------------|---------------------------------------------------------------------------------------------|
| 1.2-INT-005    | Integration | P1       | `npm run lint --workspace mcp-test-server` + smoke bundle     | Ensures regression scripts stay green for solo maintainer. Mitigates OPS-001.             |

### AC7: ChatGPT stub compatibility handled

| ID             | Level       | Priority | Test                                                                          | Justification                                                                                      |
|----------------|-------------|----------|-------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------|
| 1.2-E2E-001    | E2E        | P1       | ChatGPT Developer Mode connector setup confirms manifest + tool list accepted | Optional manual check once stubs deployed (or documented in `docs/stories/follow-ups.md`) to confirm BUS-001 compatibility risk is closed.          |

## Risk Coverage

- BUS-001: 1.2-INT-001, 1.2-E2E-001
- TECH-001: 1.2-UNIT-001, 1.2-INT-001, 1.2-INT-002, 1.2-INT-004
- SEC-001: 1.2-INT-003, 1.2-UNIT-002
- OPS-001: 1.2-INT-004, 1.2-INT-005

## Recommended Execution Order

1. 1.2-UNIT-001
2. 1.2-UNIT-002
3. 1.2-INT-001
4. 1.2-INT-003
5. 1.2-INT-002
6. 1.2-INT-004
7. 1.2-INT-005
8. 1.2-E2E-001 (manual/connector validation)

---

**Gate Summary Snippet**

```yaml
test_design:
  scenarios_total: 8
  by_level:
    unit: 2
    integration: 5
    e2e: 1
  by_priority:
    p0: 4
    p1: 4
    p2: 0
  coverage_gaps: []
```

**Trace Hook**

```
Test design matrix: docs/qa/assessments/1.2-test-design-20250922.md
P0 tests identified: 4
```

## ðŸ”¬ Research & Validation Log
- 2025-09-22: Revalidated that ChatGPT Developer Mode currently operates without `search`/`fetch` tools but continues to recommend them; retained stub coverage to avoid regressions while tracking follow-up. [Source: OpenAI Help Center â€“ Connectors in ChatGPT, accessed 2025-09-22]
- 2025-09-22: Adopted Vitest + Supertest combo for Node.js 24 ESM testing to balance speed with HTTP coverage suitable for a solo maintainer. [Sources: Medium â€“ Vitest is eating Jest for breakfast (2025-09-10); Toxigon â€“ Advanced Node.js Testing Techniques for 2025 (2025-08-18)]
