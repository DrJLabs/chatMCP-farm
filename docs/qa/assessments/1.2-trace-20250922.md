# Requirements Traceability Matrix

## Story: 1.2 – Implement OAuth Manifest & Diagnostics Behaviour

Date: 2025-09-22
Reviewer: Quinn (Test Architect)

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 5 (71.4%)
- Partially Covered: 2 (28.6%)
- Not Covered: 0 (0.0%)

### Requirement Mappings

#### AC1: `/.well-known/mcp/manifest.json` returns env-driven metadata and correct transport entry

**Coverage: FULL**

- **Integration Test**: `services/mcp-test-server/test/manifest.spec.ts::manifest populated from env`
  - Given: Test app seeded with manifest env overrides
  - When: `GET /.well-known/mcp/manifest.json`
  - Then: Response includes env-derived names/descriptions, transport list, diagnostics tool listing
  - Coverage: integration

#### AC2: PRM and root endpoints advertise canonical resource URL and emit `WWW-Authenticate`

**Coverage: FULL**

- **Integration Test**: `services/mcp-test-server/test/manifest.spec.ts::protected resource metadata`
  - Given: App configured with canonical base URL and auth required
  - When: `GET /.well-known/oauth-protected-resource`
  - Then: Response includes resource URL, authorization server, `WWW-Authenticate` header
  - Coverage: integration
- **Integration Test**: `services/mcp-test-server/test/manifest.spec.ts::root endpoint advertises transports`
  - Given: Auth-required configuration
  - When: `GET /`
  - Then: Body lists transports, allowed origins, tool metadata with challenge header present
  - Coverage: integration

#### AC3: Unauthorized `/mcp` requests set challenge headers and preserve Accept validation

**Coverage: FULL**

- **Integration Test**: `services/mcp-test-server/test/accept-header.spec.ts::returns 406 when Accept header missing`
  - Given: Auth disabled for test instance to reach Accept guard
  - When: POST `/mcp` without `Accept` header
  - Then: Service responds 406 with deterministic error payload enforcing Accept requirement
  - Coverage: integration
- **Implementation**: `src/app.ts` sets `WWW-Authenticate` when auth enabled, matching README manual workflow

#### AC4: `diagnostics.ping` echoes token claims, origin, timestamp without leaking secrets

**Coverage: FULL**

- **Unit Test**: `services/mcp-test-server/test/diagnostics.spec.ts::summarizes token claims`
  - Given: Synthetic JWT + auth info
  - When: Diagnostics payload built
  - Then: Output contains sanitized subject/audience/expiry, origin, allowed origins
  - Coverage: unit
- **Integration Test**: `services/mcp-test-server/test/manifest.spec.ts::root endpoint advertises transports`
  - Given: Diagnostics tool metadata consumed in manifest/root responses
  - When: Endpoints invoked
  - Then: Tool list matches
  - Coverage: integration

#### AC5: README & `.env.example` document diagnostics payload and curl checks

**Coverage: PARTIAL**

- **Documentation**: README updated with step-by-step curl commands and env guidance
- **Manual**: Requires human execution of curl workflow; no automated lint/test for docs

#### AC6: Regression scripts (lint/test) remain green without new env requirements

**Coverage: FULL**

- **Automation**: `npm run lint --workspaces --if-present`
- **Automation**: `npm run test --workspace mcp-test-server`
  - Given: Updated service with tests
  - When: Workspace lint & Vitest suite executed in CI/local pipeline
  - Then: All pass without additional env variables beyond documented defaults

#### AC7: Lightweight `search` & `fetch` stubs planned or implemented for ChatGPT guidance

**Coverage: PARTIAL**

- **Follow-up**: `docs/stories/follow-ups.md` tracks stub implementation (owner/date)
- **Gap**: Stubs not delivered in Story 1.2; future story must implement or waive explicitly

### Coverage Gaps

1. **AC3 – Accept header enforcement lacks automated regression**
   - Severity: Medium
   - Suggested Test: Integration test asserting 406 + challenge when `Accept` header missing
2. **AC5 – Documentation validation relies on manual execution**
   - Severity: Low
   - Suggested Test: Markdown smoke or scripted curl check as part of Story 1.3 smoke tooling
2. **AC7 – Stub tools pending follow-up**
   - Severity: Medium
   - Suggested Test: Add unit/integration tests once stubs are implemented

### Test Design Recommendations

1. Add Supertest case to POST `/mcp` without `Accept` header verifying 406 + challenge (closes AC3 gap).
2. Integrate curl workflow into upcoming smoke automation (Story 1.3) to formalize AC5 validation.
3. When stubs are delivered, ensure manifest/tool list and diagnostic coverage expand accordingly.

### Risk Assessment

- **High Risk (Medium severity)**: AC3, AC7 gaps tied to interoperability with ChatGPT clients
- **Medium Risk**: AC5 documentation relies on manual process (acceptable temporarily)
- **Low Risk**: Covered ACs validated via automated tests

Traceability complete — ready for gate integration.
