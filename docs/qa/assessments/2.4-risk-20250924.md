# Risk Profile: Story 2.4 – Upgrade Auth Kit Peer Dependencies and Documentation

Date: 2025-09-24  
Assessor: Quinn (Test Architect)

## Overview
Story 2.4 updates `packages/mcp-auth-kit` to align with the Express 5 baseline, adopts `jose@^6.1.0`, introduces a workspace-wide post-bump validation helper, and refreshes documentation shards. The work sits in the critical path for completing the dependency alignment epic; regressions could cascade across every MCP service that consumes the auth kit. The analysis focuses on dependency compatibility, security posture, release workflow, and documentation accuracy.

## Risk Matrix

| Risk ID | Category | Description | Probability | Impact | Score | Priority |
|---------|----------|-------------|-------------|--------|-------|----------|
| TECH-001 | Technical | Auth kit peer bump breaks existing Express 5 consumers due to lingering Express 4 typings or unmet peer ranges | Medium (2) | High (3) | 6 | High |
| SEC-001 | Security | `jose@^6.1.0` introduces subtle JWT/Audience handling changes that can weaken token validation if not documented and tested | Medium (2) | High (3) | 6 | High |
| OPS-001 | Operational | `postbump:test` helper or README instructions drift, leaving teams without a deterministic regression workflow after dependency upgrades | High (3) | Medium (2) | 6 | High |
| DATA-001 | Data | Removal of legacy Express middlewares (e.g., async error wrappers) exposes inconsistent error serialization that leaks sensitive debug context | Low (1) | Medium (2) | 2 | Low |
| PERF-001 | Performance | Workspace test helper adds significant runtime overhead to CI pipelines, delaying release cadence | Low (1) | Low (1) | 1 | Minimal |

**Overall Story Risk Score:** 100 – (10 + 10 + 10 + 2 + 1) = 67 (Moderate). Focus on closing the High risks to lift confidence before merge.

## Detailed Risk Register

### TECH-001 – Express Peer Regression
- **Drivers:** Removing `@types/express@4` and relaxing peers can surface missing Express 5 type coverage or implicit dependencies in downstream services (`services/github-mcp`, `templates/service`).
- **Mitigation:**
  - Run `npm ls express --workspaces` / `npm ls @types/express --workspaces` post-upgrade to ensure a single Express tree.
  - Add targeted integration checks in consuming services (Story 2.2 & 2.3) before releasing the auth kit package.
  - Confirm CI smoke pipelines remain green using the new helper script.
- **Residual Risk:** Medium×Medium (score 4) once mitigations land.

### SEC-001 – Token Validation Drift
- **Drivers:** `jose` v6 adds PQC-related algorithms and updates default parsing behaviours; mis-configuration could weaken the auth kit’s verification step or break compatibility with Keycloak-issued tokens.
- **Mitigation:**
  - Review `jose` v6 release notes and align supported algorithms with Keycloak realm defaults.
  - Add unit tests for `verifyBearerToken` (or equivalent) covering HS/RS algorithms and failure cases.
  - Update README/architecture docs with guidance on supported Node runtimes (Node 18+, `require(esm)` availability on Node 20.19+).
- **Residual Risk:** Low×High (score 3) after test coverage and documentation updates.

### OPS-001 – Regression Workflow Gaps
- **Drivers:** New `postbump:test` helper must be wired into root `package.json`, README, and team habits; without adoption, dependency bumps may skip critical workspace tests.
- **Mitigation:**
  - Ensure helper script runs `npm run test --workspaces --if-present` and is referenced in Story 2.4 change log and docs.
  - Add follow-up to update CI pipelines (e.g., `test:ci`) to invoke the helper automatically.
  - Capture execution evidence in the Dev Notes.
- **Residual Risk:** Medium×Medium (score 4) until automation proves reliable.

### DATA-001 – Error Surface Changes
- **Drivers:** Express 5 error handling differs from Express 4; removing legacy wrappers could surface stack traces or change response shape.
- **Mitigation:**
  - Add integration test to `packages/mcp-auth-kit` (or downstream consumers) verifying sanitized error payloads.
  - Document required error handler signature in README.
- **Residual Risk:** Low×Low (score 1) once tested.

### PERF-001 – Helper Runtime Overhead
- **Drivers:** Running tests across all workspaces may lengthen local and CI flows.
- **Mitigation:**
  - Measure helper runtime and note expected duration in README.
  - Encourage selective workspace flags when appropriate (e.g., `npm run postbump:test -- --workspace packages/mcp-auth-kit`).
- **Residual Risk:** Minimal.

## Mitigation & Monitoring Plan
- Execute all mitigations during implementation; log completion in Dev Notes and README updates.
- Instrument CI to surface failures from the new helper script and enforce gating.
- Post-deploy, monitor auth kit consumers for JWT validation errors or Express type warnings via smoke tests.

## Risk-Based Testing Strategy Alignment
- Prioritize unit/integration tests covering JWT verification, Express middleware wiring, and workspace helper execution (see accompanying test design).
- For OPS-001, schedule a dry-run of the helper on Node 22 and Node 20.19+ before release.

Risk profile: qa.qaLocation/assessments/2.4-risk-20250924.md
