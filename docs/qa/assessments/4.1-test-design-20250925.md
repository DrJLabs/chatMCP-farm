# Test Design: Story 4.1

Date: 2025-09-25
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 8
- Unit tests: 2 (25%)
- Integration tests: 5 (63%)
- E2E tests: 1 (12%)
- Priority distribution: P0: 4, P1: 3, P2: 1, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Multi-stage build with pinned upstream commit and stripped binary

| ID             | Level       | Priority | Test                                                           | Justification                                                                                 |
| -------------- | ----------- | -------- | -------------------------------------------------------------- | --------------------------------------------------------------------------------------------- |
| 4.1-INT-001    | Integration | P0       | `docker build` verifies `FILESYSTEM_MCP_REF` pin + `cargo build --release --locked` | Ensures deterministic build and binary stripping before image publish; mitigates TECH-001. |

### AC2: Runtime installs `mcp-proxy`, keeps image lean

| ID             | Level       | Priority | Test                                                           | Justification                                                                                 |
| -------------- | ----------- | -------- | -------------------------------------------------------------- | --------------------------------------------------------------------------------------------- |
| 4.1-INT-003    | Integration | P1       | Inspect runtime image (`docker run --entrypoint python3`) to confirm pinned `mcp-proxy` version and absence of pip cache | Validates runtime dependencies and mitigates TECH-001 regressions. |

### AC3: Entrypoint parses flags and forwards to `rust-mcp-filesystem`

| ID             | Level       | Priority | Test                                                           | Justification                                                                                 |
| -------------- | ----------- | -------- | -------------------------------------------------------------- | --------------------------------------------------------------------------------------------- |
| 4.1-UNIT-001   | Unit        | P0       | Bats/shellcheck harness calls entrypoint with default env to assert `/projects` and `/VAULTS` arguments | Prevents SEC-001 by ensuring safe defaults and parsing. |
| 4.1-UNIT-002   | Unit        | P0       | Entry-point unit test toggling `ALLOW_WRITE`/`ENABLE_ROOTS` to confirm flag injection | Guards against unintended write access; mitigates SEC-001. |
| 4.1-INT-002    | Integration | P1       | `docker run` without mounted `/VAULTS` asserts startup error explaining missing directory | Detects OPS-001 quickly and documents operator guidance. |
| 4.1-INT-005    | Integration | P0       | `docker run` with blank `FS_ALLOWED` confirms entrypoint surfaces rust-mcp-filesystem validation error instead of launching permissive server | Enforces CLI requirement for explicit allowed directories when roots disabled, closing SEC-001 gap. |

### AC4: Image exposes port `12010` and documents env contracts

| ID             | Level       | Priority | Test                                                           | Justification                                                                                 |
| -------------- | ----------- | -------- | -------------------------------------------------------------- | --------------------------------------------------------------------------------------------- |
| 4.1-INT-006    | Integration | P1       | (Shared) container inspect ensures `ExposedPorts` includes `12010/tcp`; entrypoint help output lists env vars | Confirms runtime contract for proxy layer. |
| 4.1-E2E-001    | E2E         | P1       | `docker compose` profile launches bridge + sample client, validates SSE handshake on `12010` | End-to-end confirmation that exposed port and env wiring allow MCP negotiation. |

### AC5: Dev notes document verification workflow

| ID             | Level       | Priority | Test                                                           | Justification                                                                                 |
| -------------- | ----------- | -------- | -------------------------------------------------------------- | --------------------------------------------------------------------------------------------- |
| 4.1-INT-004    | Integration | P2       | Follow documented `docker run` sample to capture root list output and attach to evidence | Confirms documentation remains accurate and actionable for operators. |

## Risk Coverage

- SEC-001 mitigated by 4.1-UNIT-001, 4.1-UNIT-002, and 4.1-INT-005 (argument parsing, flag control, and empty-roots rejection verification).
- OPS-001 mitigated by 4.1-INT-002 (negative mount scenario) and 4.1-E2E-001 (runtime validation).
- TECH-001 mitigated by 4.1-INT-001 and 4.1-INT-003 (build + runtime dependency verification).

## Recommended Execution Order

1. Run P0 unit tests (4.1-UNIT-001, 4.1-UNIT-002) to catch parsing errors quickly.
2. Execute P0 integration tests (4.1-INT-001 build determinism, 4.1-INT-005 empty-roots guardrail).
3. Proceed with P1 integration tests (4.1-INT-002, 4.1-INT-003) and P1 E2E handshake (4.1-E2E-001).
4. Finish with P2 documentation validation test (4.1-INT-004).

```
Test design matrix: qa.qaLocation/assessments/4.1-test-design-20250925.md
P0 tests identified: 4
```

## üî¨ Research & Validation Log (2025-09-25)

- Reconfirmed `rust-mcp-filesystem` CLI enforces explicit allowed directories unless Roots support is enabled; added integration scenario 4.1-INT-005 to verify `FS_ALLOWED` defaults fail safely, aligning the test plan with upstream validation expectations. ÓàÄciteÓàÇturn0search0ÓàÅ
- Reviewed latest `mcp-proxy` usage guidance to ensure handshake tests cover `--sse-port` semantics and help output, reinforcing that our E2E scenario validates the bridge on port 12010 with consistent CLI flags. ÓàÄciteÓàÇturn1search4ÓàÅ
