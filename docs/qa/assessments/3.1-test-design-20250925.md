# Test Design: Story 3.1

Date: 2025-09-25
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 9
- Unit tests: 3 (33%)
- Integration tests: 4 (44%)
- E2E tests: 2 (23%)
- Priority distribution: P0: 5, P1: 3, P2: 1

The plan favours fast unit coverage for proxy header handling and Dockerfile linting, layered with integration smoke around Compose wiring and upstream parity, then capped by Streamable HTTP end-to-end checks. Scenario IDs map back to the mitigations outlined in the risk profile (SEC-3.1-001/002, OPS-3.1-003/004, OBS-3.1-005). The coverage emphasises the standalone `github-mcp-server` binary's dependence on PAT-provided GitHub scopes and launch arguments, so we require tests that lock version pinning and upgrade checks in tandem with PAT overrides.ÓàÄciteÓàÇturn2open0ÓàÇturn3open0ÓàÅ Streamable HTTP exercises target the bridge behaviours documented for `mcp-proxy`, ensuring we validate port exposure and transport translation when the proxy fronts `github-mcp-server`.ÓàÄciteÓàÇturn0search1ÓàÇturn4open0ÓàÅ

## Test Scenarios by Acceptance Criteria

### AC1: Bridge Dockerfile builds github-mcp-server proxy image

| ID            | Level | Priority | Test Description                                                              | Justification | Mitigates |
|---------------|-------|----------|--------------------------------------------------------------------------------|---------------|-----------|
| 3.1-UNIT-001  | Unit  | P1       | Static lint/check ensuring Dockerfile pins `github-mcp-server` & `mcp-proxy` versions plus sha256 sums | Detects drift locally before builds (SEC-3.1-002). | SEC-3.1-002 |
| 3.1-UNIT-002  | Unit  | P1       | Scripted checksum verification comparing recorded hashes with downloaded archives | Guards against tampering in CI pull (SEC-3.1-002). | SEC-3.1-002 |
| 3.1-INT-001   | Integration | P0 | `docker build -f Bridge.Dockerfile` + `docker run` smoke verifying `github-mcp-server --version` and `mcp-proxy --help`, ensuring Streamable HTTP support is declared as expected.ÓàÄciteÓàÇturn2open0ÓàÇturn0search1ÓàÇturn4open0ÓàÅ | Confirms runtime binaries exist and entrypoint boots (SEC-3.1-002). | SEC-3.1-002 |

### AC2: Compose profile wires bridge service

| ID            | Level | Priority | Test Description                                                              | Justification | Mitigates |
|---------------|-------|----------|--------------------------------------------------------------------------------|---------------|-----------|
| 3.1-INT-002   | Integration | P0 | `COMPOSE_PROFILES=github-mcp scripts/compose.sh config` to assert bridge appears only under the profile | Prevents unintended startup in default stack (OPS-3.1-003). | OPS-3.1-003 |
| 3.1-INT-003   | Integration | P0 | `COMPOSE_PROFILES=github-mcp scripts/compose.sh up -d` then `docker ps`/logs to confirm dependency order | Ensures bridge ready before main app without leaking labels (OPS-3.1-003). | OPS-3.1-003 |

### AC3: Express proxy forwards headers and retains fallback

| ID            | Level | Priority | Test Description                                                              | Justification | Mitigates |
|---------------|-------|----------|--------------------------------------------------------------------------------|---------------|-----------|
| 3.1-UNIT-003  | Unit  | P0       | Jest/Vitest unit ensuring proxy helper copies Authorization, MCP headers, and defaults protocol version | Fast guardrail for header propagation (SEC-3.1-001). | SEC-3.1-001 |
| 3.1-INT-004   | Integration | P0 | Invoke `/mcp` with upstream enabled, inspect bridge logs to confirm headers and session ID survive round-trip, and assert `MCP-Protocol-Version=2025-06-18` is forwarded.ÓàÄciteÓàÇturn0reddit12ÓàÅ | Validates end-to-end auth flow (SEC-3.1-001, OPS-3.1-004). | SEC-3.1-001, OPS-3.1-004 |
| 3.1-INT-005   | Integration | P0 | Unset `MCP_UPSTREAM_URL` and re-run smoke to ensure local StreamableHTTP transport passes existing tests | Ensures rollback path intact (OPS-3.1-004). | OPS-3.1-004 |

### AC4: Environment templates updated

| ID            | Level | Priority | Test Description                                                              | Justification | Mitigates |
|---------------|-------|----------|--------------------------------------------------------------------------------|---------------|-----------|
| 3.1-INT-006   | Integration | P1 | Validate `.env`/`.env.example` diff includes new variables and documentation; run env-lint if available | Prevents misconfiguration during rollout (OPS-3.1-003, OPS-3.1-004). | OPS-3.1-003, OPS-3.1-004 |

### AC5: Validation instructions capture parity & observability

| ID            | Level | Priority | Test Description                                                              | Justification | Mitigates |
|---------------|-------|----------|--------------------------------------------------------------------------------|---------------|-----------|
| 3.1-E2E-001   | E2E   | P0       | Run full parity smoke (`tools/list`, manifest, healthz) with upstream enabled; attach artefacts to Dev Agent Record | Demonstrates complete path success (SEC-3.1-001, SEC-3.1-002). | SEC-3.1-001, SEC-3.1-002 |
| 3.1-E2E-002   | E2E   | P2       | Disable upstream, rerun smoke, and ensure docs note differences plus log locations | Validates rollback instructions and observability (OPS-3.1-004, OBS-3.1-005). | OPS-3.1-004, OBS-3.1-005 |

## Risk Coverage Summary
- **SEC-3.1-001:** 3.1-UNIT-003, 3.1-INT-004, 3.1-E2E-001
- **SEC-3.1-002:** 3.1-UNIT-001, 3.1-UNIT-002, 3.1-INT-001, 3.1-E2E-001
- **OPS-3.1-003:** 3.1-INT-002, 3.1-INT-003, 3.1-INT-006
- **OPS-3.1-004:** 3.1-INT-004, 3.1-INT-005, 3.1-INT-006, 3.1-E2E-002
- **OBS-3.1-005:** 3.1-E2E-002 (log verification follow-up)

## Recommended Execution Order
1. P0 unit tests (3.1-UNIT-001/002/003)
2. P0 integration tests (3.1-INT-001/002/003/004/005)
3. P0/P1 documentation validation (3.1-INT-006)
4. P0 E2E parity smoke (3.1-E2E-001)
5. P2 rollback/observability validation (3.1-E2E-002)

## Test Design Gate Snippet
```yaml
test_design:
  scenarios_total: 9
  by_level:
    unit: 3
    integration: 4
    e2e: 2
  by_priority:
    p0: 5
    p1: 3
    p2: 1
  coverage_gaps: []
```

## üî¨ Research & Validation Log
- 2025-09-25: Confirmed the `github-mcp-server` binary requires PAT-based authentication and exposes configurable toolset arguments, driving tests for env overrides and checksum validation.ÓàÄciteÓàÇturn2open0ÓàÇturn3open0ÓàÅ
- 2025-09-25: Reviewed `mcp-proxy` deployment guidance to ensure integration smokes assert Streamable HTTP behaviour, port exposure, and entrypoint wiring.ÓàÄciteÓàÇturn0search1ÓàÅ
- 2025-09-25: Validated Streamable HTTP protocol expectations requiring `MCP-Protocol-Version=2025-06-18` for session continuity, driving header assertions in upstream parity tests.ÓàÄciteÓàÇturn0reddit12ÓàÅ

## References
- docs/stories/3.1.github-mcp-bridge.md
- docs/qa/assessments/3.1-risk-20250925.md
- docs/architecture/coding-standards.md
